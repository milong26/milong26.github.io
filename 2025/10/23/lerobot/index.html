<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zhon.fun","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Lerobot的使用以及代码教程">
<meta property="og:type" content="article">
<meta property="og:title" content="lerobot">
<meta property="og:url" content="http://zhon.fun/2025/10/23/lerobot/index.html">
<meta property="og:site_name" content="没啥标题">
<meta property="og:description" content="Lerobot的使用以及代码教程">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-23T06:41:46.000Z">
<meta property="article:modified_time" content="2025-12-26T07:03:56.734Z">
<meta property="article:author" content="milong26">
<meta property="article:tag" content="robot">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://zhon.fun/2025/10/23/lerobot/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://zhon.fun/2025/10/23/lerobot/","path":"2025/10/23/lerobot/","title":"lerobot"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>lerobot | 没啥标题</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">没啥标题</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">活下去</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD%E4%B8%8E%E5%90%8C%E6%AD%A5"><span class="nav-number">1.</span> <span class="nav-text">代码下载与同步</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">环境配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="nav-number">3.</span> <span class="nav-text">数据集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#so100"><span class="nav-number">3.0.1.</span> <span class="nav-text">so100</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%A1%E5%87%86calibrarte"><span class="nav-number">3.0.1.1.</span> <span class="nav-text">校准&#x2F;calibrarte</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%87%E9%9B%86"><span class="nav-number">3.0.1.2.</span> <span class="nav-text">采集</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">3.0.2.</span> <span class="nav-text">代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BF%E7%9C%9F"><span class="nav-number">3.1.</span> <span class="nav-text">仿真</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#record%E4%BB%A3%E7%A0%81"><span class="nav-number">3.2.</span> <span class="nav-text">record代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#record_loop%E5%87%BD%E6%95%B0"><span class="nav-number">3.2.1.</span> <span class="nav-text">record_loop函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD"><span class="nav-number">3.3.</span> <span class="nav-text">下载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#git-clone%E6%96%B9%E5%BC%8F%E4%B8%8D%E6%80%8E%E4%B9%88%E5%A5%BD%E7%94%A8"><span class="nav-number">3.3.1.</span> <span class="nav-text">git clone方式（不怎么好用）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AE%B9"><span class="nav-number">3.4.</span> <span class="nav-text">内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7"><span class="nav-number">3.5.</span> <span class="nav-text">工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">3.5.1.</span> <span class="nav-text">可视化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%9B%86%E7%89%88%E6%9C%AC"><span class="nav-number">3.5.2.</span> <span class="nav-text">数据集版本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B"><span class="nav-number">4.</span> <span class="nav-text">模型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%AD%E7%BB%83"><span class="nav-number">5.</span> <span class="nav-text">训练</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95"><span class="nav-number">5.1.</span> <span class="nav-text">简单</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%A8%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">推理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#robot_client%E5%92%8Crecord_loop%E5%9C%A8send_action%E4%B8%8A%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">6.1.</span> <span class="nav-text">robot_client和record_loop在send_action上的区别</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#async%E6%8E%A8%E7%90%86"><span class="nav-number">7.</span> <span class="nav-text">async推理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#async-inferece-action-on-cpu"><span class="nav-number">7.1.</span> <span class="nav-text">async inferece action on cpu</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#inference-on-policy_srever"><span class="nav-number">7.2.</span> <span class="nav-text">inference on policy_srever</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#joint-ee"><span class="nav-number">8.</span> <span class="nav-text">joint-&gt;ee</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#record"><span class="nav-number">8.1.</span> <span class="nav-text">record</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98joint%E5%BD%A2%E5%BC%8F%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">8.2.</span> <span class="nav-text">保存joint形式的数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#record%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%E5%A4%84%E7%90%86%E4%B8%8E%E4%BF%9D%E5%AD%98"><span class="nav-number">8.2.1.</span> <span class="nav-text">record数据获取、处理与保存</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#metaworld"><span class="nav-number">9.</span> <span class="nav-text">metaworld</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#action%E8%BD%AC%E6%8D%A2"><span class="nav-number">10.</span> <span class="nav-text">action转换</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#lerobot-ee"><span class="nav-number">11.</span> <span class="nav-text">lerobot-ee</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E7%9A%84%E5%87%86%E5%A4%87"><span class="nav-number">11.1.</span> <span class="nav-text">通用的准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#record-1"><span class="nav-number">11.2.</span> <span class="nav-text">record</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#evaluate"><span class="nav-number">11.3.</span> <span class="nav-text">evaluate</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#predict_action"><span class="nav-number">11.3.1.</span> <span class="nav-text">predict_action</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#local"><span class="nav-number">11.3.2.</span> <span class="nav-text">local</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#async"><span class="nav-number">11.3.3.</span> <span class="nav-text">async</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9async"><span class="nav-number">11.3.3.1.</span> <span class="nav-text">修改async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#async%E6%89%A7%E8%A1%8C"><span class="nav-number">11.3.3.2.</span> <span class="nav-text">async执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C"><span class="nav-number">11.3.3.3.</span> <span class="nav-text">执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E9%97%AE%E9%A2%98"><span class="nav-number">11.3.3.4.</span> <span class="nav-text">时间问题</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#debug%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%87%AA%E5%AD%98"><span class="nav-number">12.</span> <span class="nav-text">debug配置文件自存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">12.1.</span> <span class="nav-text">服务器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pipeline"><span class="nav-number">13.</span> <span class="nav-text">pipeline</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#observation_to_transition"><span class="nav-number">13.0.1.</span> <span class="nav-text">2.
observation_to_transition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forwardkinematicsjointstoee"><span class="nav-number">13.0.2.</span> <span class="nav-text">3.
ForwardKinematicsJointsToEE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#observationprocessorstep"><span class="nav-number">13.0.3.</span> <span class="nav-text">4.
ObservationProcessorStep</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forwardkinematicsjointstoeeobservation"><span class="nav-number">13.0.4.</span> <span class="nav-text">5.
ForwardKinematicsJointsToEEObservation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compute_forward_kinematics_joints_to_ee"><span class="nav-number">13.0.5.</span> <span class="nav-text">6.
compute_forward_kinematics_joints_to_ee</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#transition_to_observation"><span class="nav-number">13.0.6.</span> <span class="nav-text">7.
transition_to_observation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">13.0.7.</span> <span class="nav-text">总结数据处理流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%AF%E8%83%BD%E7%9A%84%E6%8A%A5%E9%94%99"><span class="nav-number">14.</span> <span class="nav-text">可能的报错</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2"><span class="nav-number">15.</span> <span class="nav-text">坐标转换</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">milong26</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">88</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">80</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhon.fun/2025/10/23/lerobot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="milong26">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="没啥标题">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="lerobot | 没啥标题">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          lerobot
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-23 14:41:46" itemprop="dateCreated datePublished" datetime="2025-10-23T14:41:46+08:00">2025-10-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-12-26 15:03:56" itemprop="dateModified" datetime="2025-12-26T15:03:56+08:00">2025-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/it/" itemprop="url" rel="index"><span itemprop="name">it</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Lerobot的使用以及代码教程</p>
<span id="more"></span>
<h1 id="代码下载与同步">代码下载与同步</h1>
<ol type="1">
<li>找一个位置
<code>git clone https://github.com/huggingface/lerobot.git</code>
然后<code>git lfs fetch --all</code></li>
<li>github上新建一个空仓库比如<code>news</code></li>
<li>在本地下载的lerobot文件夹里面<code>git remote -v</code>
能看到origin指向源代码仓库git remote
-v，需要让remote指向源代码，origin指向github上面的新仓库，修改本地lerobot代码的origin和remote：先修改以前的origin：git
remote rename origin remote 然后git remote add origin
https://github.com/milong26/news.git。现在git remote
-v应该有origibn和remote了</li>
<li>git branch -M main</li>
<li>git push -u origin main</li>
</ol>
<h1 id="环境配置">环境配置</h1>
<ol type="1">
<li>仿照<a
target="_blank" rel="noopener" href="https://github.com/huggingface/lerobot?tab=readme-ov-file#installation">install</a>
<ol type="1">
<li>conda create -y -n lerobot python=3.10</li>
<li>conda activate lerobot</li>
<li>conda install ffmpeg -c conda-forge</li>
<li>pip install -e .</li>
</ol></li>
<li>基础环境搞完了，然后根据需求安装其他
<ol type="1">
<li>so100的电机：pip install -e ".[feetech]"</li>
<li>smolvla：pip install -e ".[smolvla]"</li>
<li>远程推理：pip install -e ".<a href="#async">async</a>"</li>
<li>运动学：pip install -e ".[placo-dep]"</li>
<li>realsense相机：pip install -e ".[intelrealsense]"</li>
</ol></li>
<li>linux没啥问题，有一个报错，用python3-dev代替python-dev
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Package python-dev is not available, but is referred to by another package.</span><br><span class="line">This may mean that the package is missing, has been obsoleted or is only available from another <span class="built_in">source</span></span><br><span class="line">However the following packages replace it:</span><br><span class="line">  python2-dev:i386 python2:i386 python2-dev python2 python-dev-is-python3</span><br></pre></td></tr></table></figure></li>
<li>pip
install超时，换镜像<code>pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</code></li>
<li>下载会很慢，又超时了，加上--default-timeout=100</li>
</ol>
<h1 id="数据集">数据集</h1>
<p>数据集来源：自己采集/下载开源 ## 真实
真实机器人采集（需要设备）和仿真数据采集（需要软件，有的比较高级的采集也需要设备）</p>
<p>不管是仿真还是真实，都会用到record_loop函数</p>
<p>sudo chmod 666 /dev/ttyACM0</p>
<h3 id="so100">so100</h3>
<h4 id="校准calibrarte">校准/calibrarte</h4>
<p>校准：In <code>record.py</code> , keep calibration followed
lerobot-so100-calibrate <a
target="_blank" rel="noopener" href="https://huggingface.co/docs/lerobot/so100#calibrate">huggingface</a>
or <a
target="_blank" rel="noopener" href="https://github.com/huggingface/lerobot/blob/main/docs/source/so100.mdx">github</a>,
then get 2 json file indicating follower_id.json and leadr_id.json whose
id name should be written into
<code>SO100Follower/LeaderConfig(id=)</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lerobot-calibrate \</span><br><span class="line">    --teleop.type=so100_leader \</span><br><span class="line">    --teleop.port=/dev/ttyACM1 \</span><br><span class="line">    --teleop.id=zhubi</span><br></pre></td></tr></table></figure>
<h4 id="采集">采集</h4>
<p>采集的时候错了怎么样</p>
<p>lerobot-edit-dataset<br />
--repo_id collect_data/third_camera<br />
--operation.type delete_episodes<br />
--operation.episode_indices "[16]"</p>
<p>合并数据集</p>
<p>lerobot-edit-dataset<br />
--repo_id collect_data/ecaecs_merged<br />
--operation.type merge<br />
--operation.repo_ids
"['collect_data/first_camera_ecaecs','collect_data/second_camera_ecaecs','collect_data/third_camera_ecaecs']"</p>
<h3 id="代码">代码</h3>
<h2 id="仿真">仿真</h2>
<h2 id="record代码">record代码</h2>
<h3 id="record_loop函数">record_loop函数</h3>
<p><code>record_loop</code>里面，函数的输入参数有 -
teleop_action_processor：专门用于teleoperate，原始leader的act（joint）经过这个处理变成ee
- robot_action_processor：ee形式的action经过变成joint，可以交给机器执行
- robot_observation_processor：原始obs（joint）经过这个变成ee
分成四个部分： 1. 处理obs <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">obs = robot.get_observation()</span><br><span class="line">obs_processed = robot_observation_processor(obs)</span><br><span class="line"><span class="comment"># 此时obs_processed应该要处理所有observation作为前缀的feature了</span></span><br><span class="line">observation_frame = build_dataset_frame(dataset.features, obs_processed, prefix=OBS_STR)</span><br></pre></td></tr></table></figure> 2.
处理action，两种：policy/teleoperate <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> policy <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">	action_values = predict_action(</span><br><span class="line">		observation=observation_frame,</span><br><span class="line">		policy=policy,)</span><br><span class="line">	<span class="comment"># 用模型推理出来的action调整格式</span></span><br><span class="line">	act_processed_policy: RobotAction = make_robot_action(action_values, dataset.features)</span><br><span class="line"><span class="keyword">elif</span> policy <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">isinstance</span>(teleop, Teleoperator):</span><br><span class="line">	<span class="comment"># 原始act</span></span><br><span class="line">	act = teleop.get_action()</span><br><span class="line">	act_processed_teleop = teleop_action_processor((act, obs))</span><br></pre></td></tr></table></figure> 3.
计算出要执行的action，也是两种policy和teleoperate <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Applies a pipeline to the action, default is IdentityProcessor</span></span><br><span class="line"><span class="keyword">if</span> policy <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> act_processed_policy <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">	action_values = act_processed_policy</span><br><span class="line">	robot_action_to_send = robot_action_processor((act_processed_policy, obs))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	action_values = act_processed_teleop</span><br><span class="line">	robot_action_to_send = robot_action_processor((act_processed_teleop, obs))</span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">_sent_action = robot.send_action(robot_action_to_send)</span><br></pre></td></tr></table></figure> 4.
加入数据集 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">action_frame = build_dataset_frame(dataset.features, action_values, prefix=ACTION)</span><br><span class="line">frame = &#123;**observation_frame, **action_frame, <span class="string">&quot;task&quot;</span>: single_task&#125;</span><br><span class="line">dataset.add_frame(frame)</span><br></pre></td></tr></table></figure></p>
<h2 id="下载">下载</h2>
<h3 id="git-clone方式不怎么好用">git clone方式（不怎么好用）</h3>
<ol type="1">
<li>sudo apt-get install git-lfs</li>
<li>git clone
https://hf-mirror.com/datasets/lerobot/berkeley_autolab_ur5 ### hf
cli（镜像）
这个方式得到的比较依赖huggingface代码生态（就是比较难找到真正的文件）</li>
<li>设置 HF_ENDPOINT（一次性示例） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> HF_ENDPOINT=https://hf-mirror.com</span><br></pre></td></tr></table></figure></li>
<li>验证是否设置成功</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$HF_ENDPOINT</span></span><br></pre></td></tr></table></figure>
<p>如果输出 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://hf-mirror.com</span><br></pre></td></tr></table></figure> 说明设置已生效。
<strong>范围</strong>：仅对当前 shell 会话有效（关闭终端失效）。 3.
检查是否存在代理设置 下载失败常见原因是 shell
仍保留了代理环境变量。检查方法： <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env | grep -i proxy || echo &quot;no proxy env&quot;</span><br></pre></td></tr></table></figure>
若看到如下变量仍存在（示例）： <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http_proxy=http://127.0.0.1:7890/</span><br><span class="line">https_proxy=http://127.0.0.1:7890/</span><br><span class="line">HTTP_PROXY=http://127.0.0.1:7890/</span><br><span class="line">HTTPS_PROXY=http://127.0.0.1:7890/</span><br></pre></td></tr></table></figure>
说明请求会强制走本地代理（即使你关闭了代理软件），容易触发 <code>Connection refused</code>。
&gt;
<code>no_proxy/NO_PROXY</code> 仅表示“这些地址不走代理”，不会影响你直连外网。
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -U &quot;huggingface_hub[cli]&quot;</span><br></pre></td></tr></table></figure> 之后就可以直接下载数据集/模型了 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hf download lerobot/pi05_base</span><br></pre></td></tr></table></figure>
下载的模型放在哪里？默认在<code>~/.cache/huggingface/hub/models--lerobot--pi0_base/snapshots</code>
如果用lerobot的代码直接id就能对应到这个位置，否则需要自己转移位置，或者hf
download的时候设置好 4. hf download下载的文件在哪里？什么格式？ hf
download
lerobot/pi0_base这个命令下载的文件，~/.cache/huggingface/hub/models--lerobot--pi0_base/这个目录里面，有3个文件夹，snapshots,refs和blobs
看起来只有snapshots里面的比较像文件，有文件名而不是奇怪的数字和字母组合，但是，它并不是真正的文件，只是符号链接
<code>snapshots/...</code> 目录下的文件都是 <strong>符号链接（symlink）</strong>，指向 <code>blobs/...</code> 目录下的实际文件
这是 Hugging Face Hub 的 <strong>去重存储（content-addressable
storage）</strong> 机制
下载到本地以后直接repo_id，pretrained_path_or_name改成id就能直接访问到了</p>
<h2 id="内容">内容</h2>
<ul>
<li><strong><code>meta/info.json</code></strong>: 配置和feature等</li>
<li><strong><code>meta/stats.json</code></strong>:
mean/std/min/max这些<code>dataset.meta.stats</code></li>
<li><strong><code>meta/tasks.jsonl</code></strong>: 任务</li>
<li><strong><code>meta/episodes/</code></strong>: per‑episode records
(lengths, tasks, offsets) stored as <strong>chunked Parquet</strong> for
scalability.</li>
<li><strong><code>data/</code></strong>:
frame‑by‑frame <strong>Parquet</strong> shards; each file typically
contains <strong>many episodes</strong>.</li>
<li><strong><code>videos/</code></strong>: <strong>MP4</strong> shards
per camera; each file typically contains <strong>many
episodes</strong>.</li>
</ul>
<h2 id="工具">工具</h2>
<h3 id="可视化">可视化</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lerobot-dataset-viz \</span><br><span class="line">    --repo-id lerobot/pusht \</span><br><span class="line">    --episode-index 0</span><br></pre></td></tr></table></figure>
<h3 id="数据集版本">数据集版本</h3>
<p>现在数据集已经变成3.0版本了，之前2.1的都用不了 1. 安装支持
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install <span class="string">&quot;https://github.com/huggingface/lerobot/archive/33cad37054c2b594ceba57463e8f11ee374fa93c.zip&quot;</span></span><br></pre></td></tr></table></figure> 2. 转换 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYTHONPATH=src python -m lerobot.datasets.v30.convert_dataset_v21_to_v30 --repo-id=&lt;HF_USER/DATASET_ID&gt;</span><br></pre></td></tr></table></figure>
转换如果是写local的话local的位置现在用root/repo_id表示数据集的位置了，具体看convert代码
### 删除feature
直接命令行，会直接在原来的基础上修改，所以最好备份原始数据集
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lerobot-edit-dataset \</span><br><span class="line">    --repo_id lerobot/pusht \</span><br><span class="line">    --operation.type remove_feature \</span><br><span class="line">    --operation.feature_names <span class="string">&quot;[&#x27;observation.images.top&#x27;]&quot;</span></span><br></pre></td></tr></table></figure> ### 修改feature 实现了一个能用的 rename
feature.py但是比较慢，能用就行</p>
<h1 id="模型">模型</h1>
<p>下载方式和数据集差不多，但是模型可能有多个</p>
<h1 id="训练">训练</h1>
<h2 id="简单">简单</h2>
<p>想用指定的卡id训练 1. 直接命令行 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HF_HUB_OFFLINE=1 CUDA_VISIBLE_DEVICES=0,1,2 accelerate launch \</span><br><span class="line">  --multi_gpu \</span><br><span class="line">  --num_processes=3 \</span><br><span class="line">  src/lerobot/scripts/lerobot_train.py \</span><br><span class="line">  --config_path=fscript/finetune/simple_test.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure> 2.
会有一个警告（暂时不知道为什么导致）忽视也没关系但是输出太多了影响我看真正的报错
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks... To disable this warning, you can either: - Avoid using `tokenizers` before the fork if possible - Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)</span><br></pre></td></tr></table></figure> 原因：<code>huggingface/tokenizers</code> 的 <strong>fast
tokenizer</strong> 内部默认会用多线程（并行化加速）。Python 的
<code>fork</code>（比如在 <code>multiprocessing</code> 或 PyTorch
<code>DataLoader(num_workers&gt;0)</code>）会复制parent进程。如果parent进程已经启动了
tokenizer 的线程池，再 fork
child进程，就可能死锁，是一个使用顺序的问题。解决方案是需要我们手动显式设置该变量TOKENIZERS_PARALLELISM是否支持tokens并行。即在程序前面加上以下代码行就可以。
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;TOKENIZERS_PARALLELISM&quot;</span>] = <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure> ## multi gpu 原来支持multi-gpu training了<a
target="_blank" rel="noopener" href="https://huggingface.co/docs/lerobot/multi_gpu_training">multi-gpu
training</a></p>
<p>训练ACT 准备好数据集 这样好想就能进入训练了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">lerobot-train \</span><br><span class="line">  --dataset.repo_id=lerobot/ecaecs_merged \</span><br><span class="line">  --dataset.root=/home/zhonglinyue/.cache/huggingface/lerobot/ecaecs_merged \</span><br><span class="line">  --policy.type=act \</span><br><span class="line">  --output_dir=outputs/train/act_cam \</span><br><span class="line">  --job_name=act_with_ecaecs_dataset \</span><br><span class="line">  --policy.device=cuda \</span><br><span class="line">  --policy.push_to_hub=false \</span><br><span class="line">  --wandb.enable=true \</span><br><span class="line">  --wandb.mode=offline \</span><br><span class="line">  --steps=20000</span><br><span class="line">  --</span><br></pre></td></tr></table></figure>
<p>训练smolvla</p>
<h1 id="推理">推理</h1>
<h2
id="robot_client和record_loop在send_action上的区别">robot_client和record_loop在send_action上的区别</h2>
<p>一般直接推理joint-send_action(joint)是没关系的，但是如果我再robot_client里面send_action之前做了其它操作的话，这个操作时间会影响send_action的执行效果，也就是joint_action同步写入不到位。
这一部分需要了解 - [ ]
robot_client_ee的代码和evaluate相比，send_action之后有什么操作打断了写？
- [ ] 怎样演唱robot_client的等待时间，让它可以等写完再执行下一次行为 1.
sync是什么[[同步和异步]] &lt;-sync是同步那应该写完再执行别的 2.
evaluate的按照fps控制。</p>
<p>evalute的时间控制：send_action一定会写完。假设fps控制的循环时间一次30ms。这一次前面花费了20ms，send_action需要消耗6ms，那执行之后等待4ms，进入下一次。如果前面花了30ms，send_action需要消耗6ms，超过30ms了就不等待，直接进入
下一次。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> timestamp &lt; control_time_s:</span><br><span class="line">	start_loop_t = time.perf_counter()</span><br><span class="line">	<span class="comment"># 获得observation</span></span><br><span class="line">	obs = robot.get_observation()</span><br><span class="line">	<span class="comment"># 计算action</span></span><br><span class="line">	action_values = predict_action(observation=observation_frame)</span><br><span class="line">	<span class="comment"># 转换action到joint能接受的</span></span><br><span class="line">	robot_action_to_send = robot_action_processor((action_values, obs))</span><br><span class="line">	_sent_action = robot.send_action(robot_action_to_send)</span><br><span class="line">	<span class="comment"># Write to dataset</span></span><br><span class="line">	dataset.add_frame(frame)</span><br><span class="line">	dt_s = time.perf_counter() - start_loop_t</span><br><span class="line">	<span class="comment"># 控制时间</span></span><br><span class="line">	precise_sleep(<span class="number">1</span> / fps - dt_s)</span><br></pre></td></tr></table></figure>
<p>robot_client_ee.py的时间控制比较复杂 1.
核心流程包含三个：执行action，捕获观察，sleep的时间也是和evaluate比较像，要确认self.config.environment_dt是否和1/fps一致。
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">control_loop</span>(<span class="params">self, task, verbose=<span class="literal">False</span></span>):</span><br><span class="line">	<span class="keyword">while</span> self.running:</span><br><span class="line">	    <span class="keyword">if</span> self.actions_available():</span><br><span class="line">	        _performed_action = self.control_loop_action(verbose)</span><br><span class="line">	    <span class="keyword">if</span> self._ready_to_send_observation():</span><br><span class="line">	        _captured_observation = self.control_loop_observation(task, verbose)</span><br><span class="line">	</span><br><span class="line">	    time.sleep(<span class="built_in">max</span>(<span class="number">0</span>, self.config.environment_dt - (time.perf_counter() - control_loop_start)))</span><br><span class="line"></span><br></pre></td></tr></table></figure> 2. <code>control_loop_action</code>这个函数里面
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从queue里面获取action</span></span><br><span class="line">timed_action = self.action_queue.get_nowait()</span><br><span class="line">ee_action = self._action_tensor_to_action_dict(timed_action.get_action())</span><br><span class="line">joint_action = self.ee_to_follower_joints((ee_action, obs))</span><br><span class="line">_performed_action = self.robot.send_action(joint_action)</span><br></pre></td></tr></table></figure></p>
<h1 id="async推理">async推理</h1>
<h2 id="async-inferece-action-on-cpu">async inferece action on cpu</h2>
<p>现在有个bug是服务器推理本地cpu执行，报错说“RuntimeError: Attempting
to deserialize object on a CUDA device but torch.cuda.is_available() is
False. If you are running on a CPU-only machine, please use torch.load
with map_location=torch.device('cpu') to map your storages to the CPU.”
但按照它的该法也会报错</p>
<p>github.com/huggingface/lerobot/issues/2244
提供了一个方案：改policy_server.py，传之前做好cpu转换 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;5. Convert to TimedAction list&quot;&quot;&quot;</span></span><br><span class="line">action_chunk = self._time_action_chunk(</span><br><span class="line">    observation_t.get_timestamp(), <span class="built_in">list</span>(action_tensor.cpu()), observation_t.get_timestep()</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h2 id="inference-on-policy_srever">inference on policy_srever</h2>
<ol type="1">
<li>policy &amp; preprocessor/postprocessor <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">self.policy = policy_class.from_pretrained(policy_specs.pretrained_name_or_path)</span><br><span class="line"><span class="comment"># Load preprocessor and postprocessor, overriding device to match requested device</span></span><br><span class="line">device_override = &#123;<span class="string">&quot;device&quot;</span>: self.device&#125;</span><br><span class="line">self.preprocessor, self.postprocessor = make_pre_post_processors(</span><br><span class="line">	self.policy.config,</span><br><span class="line">	pretrained_path=policy_specs.pretrained_name_or_path,</span><br><span class="line">	preprocessor_overrides=&#123;</span><br><span class="line">		<span class="string">&quot;device_processor&quot;</span>: device_override,</span><br><span class="line">		<span class="string">&quot;rename_observations_processor&quot;</span>: &#123;<span class="string">&quot;rename_map&quot;</span>: policy_specs.rename_map&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">	postprocessor_overrides=&#123;<span class="string">&quot;device_processor&quot;</span>: device_override&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
<li>mostly in <code>_predict_action_chunk</code> triggered by
<code>action_chunk = self._predict_action_chunk(obs)</code>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_predict_action_chunk</span>(<span class="params">self, observation_t: TimedObservation</span>) -&gt; <span class="built_in">list</span>[TimedAction]:</span><br><span class="line">       <span class="string">&quot;&quot;&quot;Predict an action chunk based on an observation.</span></span><br><span class="line"><span class="string">       Pipeline:</span></span><br><span class="line"><span class="string">       1. Convert raw observation to LeRobot format</span></span><br><span class="line"><span class="string">       2. Apply preprocessor (tokenization, normalization, batching, device placement)</span></span><br><span class="line"><span class="string">       3. Run policy inference to get action chunk</span></span><br><span class="line"><span class="string">       4. Apply postprocessor (unnormalization, device movement)</span></span><br><span class="line"><span class="string">       5. Convert to TimedAction list</span></span><br><span class="line"><span class="string">       &quot;&quot;&quot;</span></span><br><span class="line">       <span class="string">&quot;&quot;&quot;1. Prepare observation&quot;&quot;&quot;</span></span><br><span class="line">       observation: Observation = raw_observation_to_observation(</span><br><span class="line">           observation_t.get_observation(),</span><br><span class="line">           self.lerobot_features,</span><br><span class="line">           self.policy_image_features,</span><br><span class="line">       )</span><br><span class="line"></span><br><span class="line">       <span class="string">&quot;&quot;&quot;2. Apply preprocessor&quot;&quot;&quot;</span></span><br><span class="line">       observation = self.preprocessor(observation)</span><br><span class="line"></span><br><span class="line">       <span class="string">&quot;&quot;&quot;3. Get action chunk&quot;&quot;&quot;</span></span><br><span class="line">       action_tensor = self._get_action_chunk(observation)</span><br><span class="line">       <span class="string">&quot;&quot;&quot;4. Apply postprocessor&quot;&quot;&quot;</span></span><br><span class="line">       <span class="comment"># Apply postprocessor (handles unnormalization and device movement)</span></span><br><span class="line">       <span class="comment"># Postprocessor expects (B, action_dim) per action, but we have (B, chunk_size, action_dim)</span></span><br><span class="line">       <span class="comment"># So we process each action in the chunk individually</span></span><br><span class="line">       _, chunk_size, _ = action_tensor.shape</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Process each action in the chunk</span></span><br><span class="line">       processed_actions = []</span><br><span class="line">       <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(chunk_size):</span><br><span class="line">           <span class="comment"># Extract action at timestep i: (B, action_dim)</span></span><br><span class="line">           single_action = action_tensor[:, i, :]</span><br><span class="line">           processed_action = self.postprocessor(single_action)</span><br><span class="line">           processed_actions.append(processed_action)</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Stack back to (B, chunk_size, action_dim), then remove batch dim</span></span><br><span class="line">       action_tensor = torch.stack(processed_actions, dim=<span class="number">1</span>).squeeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">       <span class="string">&quot;&quot;&quot;5. Convert to TimedAction list&quot;&quot;&quot;</span></span><br><span class="line">       action_chunk = self._time_action_chunk(</span><br><span class="line">           observation_t.get_timestamp(), <span class="built_in">list</span>(action_tensor), observation_t.get_timestep()</span><br><span class="line">       )</span><br><span class="line">       <span class="keyword">return</span> action_chunk </span><br></pre></td></tr></table></figure></li>
<li>What does <code>raw_observation_to_observation</code> do?
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">raw_observation_to_observation</span>(<span class="params"></span></span><br><span class="line"><span class="params">    raw_observation: RawObservation,</span></span><br><span class="line"><span class="params">    lerobot_features: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">dict</span>],</span></span><br><span class="line"><span class="params">    policy_image_features: <span class="built_in">dict</span>[<span class="built_in">str</span>, PolicyFeature],</span></span><br><span class="line"><span class="params"></span>) -&gt; Observation:</span><br><span class="line">    observation = &#123;&#125;</span><br><span class="line">    observation = prepare_raw_observation(raw_observation, lerobot_features, policy_image_features)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> observation.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(v, torch.Tensor):  <span class="comment"># VLAs present natural-language instructions in observations</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;image&quot;</span> <span class="keyword">in</span> k:</span><br><span class="line">                <span class="comment"># Policy expects images in shape (B, C, H, W)</span></span><br><span class="line">                observation[k] = prepare_image(v).unsqueeze(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            observation[k] = v</span><br><span class="line">    <span class="keyword">return</span> observation </span><br></pre></td></tr></table></figure></li>
<li>details in prepare_raw_observation and prepare_image
<ol type="1">
<li>prepare_raw_observation . In <code>resize</code> function I found
difference between local inference and async inference (the problem I
asked in title.) <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_raw_observation</span>(<span class="params"></span></span><br><span class="line"><span class="params">    robot_obs: RawObservation,</span></span><br><span class="line"><span class="params">    lerobot_features: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">dict</span>],</span></span><br><span class="line"><span class="params">    policy_image_features: <span class="built_in">dict</span>[<span class="built_in">str</span>, PolicyFeature],</span></span><br><span class="line"><span class="params"></span>) -&gt; Observation:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Matches keys from the raw robot_obs dict to the keys expected by a given policy (passed as</span></span><br><span class="line"><span class="string">    policy_image_features).&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. &#123;motor.pos1:value1, motor.pos2:value2, ..., laptop:np.ndarray&#125; -&gt;</span></span><br><span class="line">    <span class="comment"># -&gt; &#123;observation.state:[value1,value2,...], observation.images.laptop:np.ndarray&#125;</span></span><br><span class="line">    <span class="comment"># Indeed it runs  build_dataset_frame(lerobot_features, robot_obs, prefix=OBS_STR)</span></span><br><span class="line">    lerobot_obs = make_lerobot_observation(robot_obs, lerobot_features)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. Greps all observation.images.&lt;&gt; keys</span></span><br><span class="line">    image_keys = <span class="built_in">list</span>(<span class="built_in">filter</span>(is_image_key, lerobot_obs))</span><br><span class="line">    <span class="comment"># state&#x27;s shape is expected as (B, state_dim)</span></span><br><span class="line">    state_dict = &#123;OBS_STATE: extract_state_from_raw_observation(lerobot_obs)&#125;</span><br><span class="line">    <span class="comment"># extract_images_from_raw_observation return torch.tensor(lerobot_obs[camera_key])</span></span><br><span class="line">    image_dict = &#123;</span><br><span class="line">        image_k: extract_images_from_raw_observation(lerobot_obs, image_k) <span class="keyword">for</span> image_k <span class="keyword">in</span> image_keys</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># Turns the image features to (C, H, W) with H, W matching the policy image features.</span></span><br><span class="line">    <span class="comment"># This reduces the resolution of the images</span></span><br><span class="line">    image_dict = &#123;</span><br><span class="line">        key: resize_robot_observation_image(torch.tensor(lerobot_obs[key]), policy_image_features[key].shape)</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> image_keys</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;task&quot;</span> <span class="keyword">in</span> robot_obs:</span><br><span class="line">        state_dict[<span class="string">&quot;task&quot;</span>] = robot_obs[<span class="string">&quot;task&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;**state_dict, **image_dict&#125;</span><br></pre></td></tr></table></figure></li>
<li>resize_robot_observation_image <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">resize_robot_observation_image</span>(<span class="params">image: torch.tensor, resize_dims: <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>]</span>) -&gt; torch.tensor:</span><br><span class="line">    <span class="keyword">assert</span> image.ndim == <span class="number">3</span>, <span class="string">f&quot;Image must be (C, H, W)! Received <span class="subst">&#123;image.shape&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># (H, W, C) -&gt; (C, H, W) for resizing from robot obsevation resolution to policy image resolution</span></span><br><span class="line">    image = image.permute(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    dims = (resize_dims[<span class="number">1</span>], resize_dims[<span class="number">2</span>])</span><br><span class="line">    <span class="comment"># Add batch dimension for interpolate: (C, H, W) -&gt; (1, C, H, W)</span></span><br><span class="line">    image_batched = image.unsqueeze(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># Interpolate and remove batch dimension: (1, C, H, W) -&gt; (C, H, W)</span></span><br><span class="line">    resized = torch.nn.functional.interpolate(image_batched, size=dims, mode=<span class="string">&quot;bilinear&quot;</span>, align_corners=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resized.squeeze(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></li>
<li>prepare_image <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_image</span>(<span class="params">image: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Minimal preprocessing to turn int8 images to float32 in [0, 1], and create a memory-contiguous tensor&quot;&quot;&quot;</span></span><br><span class="line">    image = image.<span class="built_in">type</span>(torch.float32) / <span class="number">255</span></span><br><span class="line">    image = image.contiguous()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> image</span><br></pre></td></tr></table></figure></li>
</ol></li>
</ol>
<h1 id="joint-ee">joint-&gt;ee</h1>
<h2 id="record">record</h2>
<ol type="1">
<li>record的数据逻辑：
<ol type="1">
<li>follower_joints_to_ee：follower当前的状态state（ee格式）</li>
<li>leader_joints_to_ee：leader的目标动作（ee格式）</li>
<li>ee_to_follower_joints：没有像lerobot以前那样joint-&gt;joint的teleoperate方法，而是用leader的ee
action计算follower的joint
action。（那岂不是就能验证它能否teleoperate别的？）</li>
</ol></li>
<li>操作过程
<ol type="1">
<li>modifiying settings in <code>record.py</code> in
<code>examples/so100_to_so100_EE</code> to set cameras/robots/datasets'
episodes. etc.</li>
<li>Download <a
href="It%20is%20highly%20recommended%20to%20use%20the%20urdf%20in%20the%20SO-ARM100%20repo:%20https://github.com/TheRobotStudio/SO-ARM100/blob/main/Simulation/SO101/so101_new_calib.urdf">ursf</a>
and tell code where to find it.</li>
<li>Then directly run python record.py to start record. In default the
dataset will be saved with state/action in ee type.</li>
</ol></li>
</ol>
<h2 id="保存joint形式的数据">保存joint形式的数据</h2>
<p>record里面的调用形式 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create the dataset</span></span><br><span class="line">dataset = LeRobotDataset.create(</span><br><span class="line">    repo_id=HF_REPO_ID,</span><br><span class="line">    fps=FPS,</span><br><span class="line">    features=combine_feature_dicts(</span><br><span class="line">        <span class="comment"># Run the feature contract of the pipelines</span></span><br><span class="line">        <span class="comment"># This tells you how the features would look like after the pipeline steps</span></span><br><span class="line">        aggregate_pipeline_dataset_features(</span><br><span class="line">            pipeline=leader_joints_to_ee,</span><br><span class="line">            initial_features=create_initial_features(action=leader.action_features),</span><br><span class="line">            use_videos=<span class="literal">True</span>,</span><br><span class="line">        ),</span><br><span class="line">        aggregate_pipeline_dataset_features(</span><br><span class="line">            pipeline=follower_joints_to_ee,</span><br><span class="line">            initial_features=create_initial_features(observation=follower.observation_features),</span><br><span class="line">            use_videos=<span class="literal">True</span>,</span><br><span class="line">        ),</span><br><span class="line">    ),</span><br><span class="line">    robot_type=follower.name,</span><br><span class="line">    use_videos=<span class="literal">True</span>,</span><br><span class="line">    image_writer_threads=<span class="number">4</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><code>feature</code>关键字里面，流程是 <figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(raw robot data)</span><br><span class="line">    ↓</span><br><span class="line"><span class="built_in">create_initial_features</span>()</span><br><span class="line">    ↓</span><br><span class="line"><span class="built_in">aggregate_pipeline_dataset_features</span>(pipeline=leader_joints_to_ee)</span><br><span class="line">    ↓</span><br><span class="line"><span class="built_in">combine_feature_dicts</span>(...)   ← merge leader + follower 的特征</span><br><span class="line">    ↓</span><br><span class="line">LeRobotDataset<span class="selector-class">.create</span>(...)   ← 把特征schema + 数据保存为HF Dataset</span><br></pre></td></tr></table></figure></p>
<p><code>create_initial_features()</code>构建初始的特征结构（feature
dict），告诉 pipeline 原始输入有哪些字段。</p>
<p><code>aggregate_pipeline_dataset_features</code>这个函数主要的功能是把一个数据处理管线（<code>DataProcessorPipeline</code>）输出的特征，整理、筛选并格式化成可用于
Hugging Face LeRobot 数据集的标准特征字典。</p>
<p><code>combine_feature_dicts(*dicts)</code>把多个 pipeline 的特征
schema 合并</p>
<p>要求同时保存ee和joint形式的action/state，需要修改feature，在原来的pipeline基础上加保存原始数据的，修改dataset的feature</p>
<h3 id="record数据获取处理与保存">record数据获取、处理与保存</h3>
<p>2个函数，一个是dataset =
LeRobotDataset.create(features)，另一个是record_loop。分别负责dataset空数据集的feture设置和数据填入</p>
<ol type="1">
<li>features里面是把它原来的action和state变成了与joint
name符合的类型。参考lerobot_record的代码，发现了 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">teleop_action_processor, robot_action_processor, robot_observation_processor = make_default_processors()</span><br><span class="line"></span><br><span class="line">dataset_features = combine_feature_dicts(</span><br><span class="line">    aggregate_pipeline_dataset_features(</span><br><span class="line">        pipeline=teleop_action_processor,</span><br><span class="line">        initial_features=create_initial_features(</span><br><span class="line">            action=robot.action_features</span><br><span class="line">        ),  <span class="comment"># TODO(steven, pepijn): in future this should be come from teleop or policy</span></span><br><span class="line">        use_videos=cfg.dataset.video,</span><br><span class="line">    ),</span><br><span class="line">    aggregate_pipeline_dataset_features(</span><br><span class="line">        pipeline=robot_observation_processor,</span><br><span class="line">        initial_features=create_initial_features(observation=robot.observation_features),</span><br><span class="line">        use_videos=cfg.dataset.video,</span><br><span class="line">    ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
<li>如果直接新增，会导致action有多个部分，怎样区分开？</li>
<li>数据填入</li>
</ol>
<p>整个流程： 1. lerobot-record
--config_path=tools/collect/collect_complex_movement.yaml
采集joint形式的data 2. python examples/so100_to_so100_EE/new_change.py
正运动学 3. python examples/so100_to_so100_EE/new_replay.py
用ee数据反解并执行，感觉还是有细微差距的 4. python
examples/so100_to_so100_EE/compare_2_actions.py 比较 1.
新问题：new_replay和compare_2_actions在计算action使用的obs不一样，要改成执行动作之后
2.
新问题2：transfer的时候没有问题吗？使用本地的state_joint数值，但是fk为什么要用state？</p>
<p>fk的计算过程in lerobot 🧩 一、record_loop 的总体数据流逻辑</p>
<p>在 record_loop() 中，执行循环 roughly 如下：</p>
<p>obs = robot.get_observation() # ① 获取机器人的关节状态（joints）
obs_processed = robot_observation_processor(obs) # ② 对 observation
做处理（通常FK）</p>
<p>act = teleop.get_action() # ③ 从 teleop 设备拿动作（leader 的
joints） act_processed_teleop = teleop_action_processor((act, obs)) # ④
对动作处理（通常FK）</p>
<p>robot_action_to_send = robot_action_processor((act_processed_teleop,
obs)) # ⑤ 做IK robot.send_action(robot_action_to_send) # ⑥
发给follower执行</p>
<p>从数据流角度看：</p>
<pre><code>teleop_action_processor：leader joints → leader EE

robot_action_processor：EE → follower joints

robot_observation_processor：follower joints → follower EE</code></pre>
<h1 id="metaworld">metaworld</h1>
<ol type="1">
<li><p>下载数据集（） export HF_ENDPOINT=https://hf-mirror.com hf
download lerobot/metaworld_mt50 --repo-type=dataset --token
复制token（需要能进huggingface官网）<br />
</p></li>
<li><p>环境 pip install -e ".[metaworld,smolvla]" hf download
HuggingFaceTB/SmolVLM2-500M-Instruct hf download
lerobot/smolvla_base</p></li>
<li><p>测试一个已经训练好的模型：检查metaworld环境 下载模型hf download
jadechoghari/smolvla_metaworld --token
复制token（需要能进huggingface官网） HF_HUB_OFFLINE=1 lerobot-eval<br />
--policy.path="jadechoghari/smolvla_metaworld"<br />
--env.type=metaworld<br />
--env.task=medium<br />
--eval.batch_size=1<br />
--eval.n_episodes=2</p></li>
<li><p>重新校准</p></li>
</ol>
<p>lerobot-calibrate<br />
--teleop.type=so100_leader<br />
--teleop.port=/dev/ttyACM1<br />
--teleop.id=foree_leader</p>
<p>lerobot-calibrate<br />
--robot.type=so100_follower<br />
--robot.port=/dev/ttyACM0<br />
--robot.id=foree_follower</p>
<ol type="1">
<li>保存的action不应该是follower读出来的，那只要保证不会跳变+精度足够就ok了？</li>
<li>之前没有安装深度相关的：pyrealsense2</li>
<li>采集：lerobot-record
--config_path=tools/collect/collect_joint_test.yaml</li>
<li>replay下joint控制的效果：lerobot-replay --robot.type=so100_follower
--robot.port=/dev/ttyACM0 --robot.id=follower
--dataset.repo_id=test_10/ee --dataset.episode=2
同时可以运行一个录制代码</li>
<li>joint变成ee：python examples/so100_to_so100_EE/new_change.py</li>
<li>visu</li>
</ol>
<p>感觉先collect再change不好，还是直接collect吧。
先在服务器上处理好模型等 1. 下载位置在~/.cache/huggingface/hub 2. export
HF_ENDPOINT=https://hf-mirror.com 3. hf download
HuggingFaceTB/SmolVLM2-500M-Instruct 4. hf download
lerobot/smolvla_base</p>
<p>选择哪种方式？ 看action保存的形式：使用pipeline的时候，
follower-&gt;raw_obs-&gt;robot_action_processor-&gt;obs_processed-&gt;dataset
leader-&gt;raw_act-&gt;teleop_action_process-&gt;act_processed_teleop=action_values-&gt;dataset
act_processed_teleop-&gt;robot_observation_processor-&gt;robot_action_sent-&gt;执行</p>
<p>所以还是保存record比较好，处理一下代码，修改了record_loop里面</p>
<p>rsync -avz /path/to/local/folder/
username@remote_host:/path/to/remote/folder/</p>
<p>rsync -avz test1110/
user@10.10.16.18:/home/user/.cache/huggingface/lerobot/test1110/</p>
<p>accelerate launch<br />
--multi_gpu<br />
--num_processes=2<br />
$(which lerobot-train)<br />
--policy.path=lerobot/smolvla_base<br />
--dataset.repo_id=test1110/merged<br />
--batch_size=64<br />
--steps=20000<br />
--output_dir=outputs/train/ee_action_ee_state<br />
--job_name=my_smolvla_training<br />
--policy.device=cuda<br />
--wandb.enable=false</p>
<p>CUDA_VISIBLE_DEVICES=0 HF_HUB_OFFLINE=1 lerobot-train<br />
--policy.path=lerobot/smolvla_base<br />
--dataset.repo_id=test1110/merged<br />
--batch_size=64<br />
--steps=20000<br />
--output_dir=outputs/train/ee_action_ee_state<br />
--job_name=my_smolvla_training<br />
--policy.device=cuda<br />
--wandb.enable=false<br />
--policy.push_to_hub=false<br />
--rename_map='{"observation.images.side": "observation.images.camera1",
"observation.images.wrist": "observation.images.camera2"}'</p>
<p>CUDA_VISIBLE_DEVICES=1 HF_HUB_OFFLINE=1 lerobot-train<br />
--policy.path=lerobot/smolvla_base<br />
--dataset.repo_id=test1110/merged<br />
--batch_size=64<br />
--steps=20000<br />
--output_dir=outputs/train/joint_action_joint_state<br />
--job_name=my_smolvla_training_joint<br />
--policy.device=cuda<br />
--wandb.enable=false<br />
--policy.push_to_hub=false<br />
--rename_map='{"observation.images.side": "observation.images.camera1",
"observation.images.wrist": "observation.images.camera2"}'</p>
<p>rsync -av --progress --exclude='*.safetensors'
user@10.10.16.18:/home/user/working_folder/lerobot/outputs/
/home/user/gene/lerobot/outputs/</p>
<p>python -m lerobot.async_inference.policy_server<br />
--host=10.10.16.18<br />
--port=8080</p>
<p>python -m lerobot.async_inference.robot_client<br />
--server_address=10.10.16.18:8080<br />
--robot.type=so100_follower<br />
--robot.port=/dev/ttyACM0<br />
--robot.id=follower<br />
--robot.cameras="{ camera1: {type: intelrealsense,
serial_number_or_name: 806312060427, width: 640, height: 480, fps: 30,
use_depth: False}, camera2: {type: opencv, index_or_path: 6, width: 640,
height: 480, fps: 30}}"<br />
--task="pick up the yellow sachet and place it into the box."<br />
--policy_type=smolvla<br />
--pretrained_name_or_path=outputs/train/ee_action_ee_state/checkpoints/020000/pretrained_model<br />
--policy_device=cuda<br />
--actions_per_chunk=50<br />
--chunk_size_threshold=0.5<br />
--aggregate_fn_name=weighted_average<br />
--debug_visualize_queue_size=True</p>
<h1 id="action转换">action转换</h1>
<p>lerobot里面提供了一个：examples/so100_to_so100_EE，看一下这部分代码做了什么？</p>
<p>四个代码，record，replay，evaluate和teleoperate，分别做</p>
<p><a
target="_blank" rel="noopener" href="https://github.com/box2ai-robotics/lerobot-kinematics/tree/main">lerobot-kinematics</a></p>
<h1 id="lerobot-ee">lerobot-ee</h1>
<h2 id="通用的准备">通用的准备</h2>
<p>模型文件下载：<code>git clone https://github.com/TheRobotStudio/SO-ARM100.git</code></p>
<h2 id="record-1">record</h2>
<p>修改代码，能支持同时保存ee和joint形式的action和state</p>
<p>原来代码的逻辑：构建feature：action和state（7位），然后record_loop，用pipeline转化后存储save
episode
我修改的逻辑：重新写feature：默认的action和state就还是用7位的feature，新增joint形式的action和state两个feature，保存的时候也一起写。</p>
<p>修改的代码段</p>
<ol type="1">
<li>record.py里面只要加入新的feature就可以了，直接暴力添加
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加两个feature</span></span><br><span class="line">new_features[<span class="string">&quot;joint_action&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&quot;dtype&quot;</span>: <span class="string">&quot;float32&quot;</span>,</span><br><span class="line">    <span class="string">&quot;shape&quot;</span>: (<span class="number">6</span>,),</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [<span class="string">&quot;shoulder_pan.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;shoulder_lift.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;elbow_flex.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;wrist_flex.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;wrist_roll.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;gripper.pos&quot;</span></span><br><span class="line">            ],</span><br><span class="line">    <span class="comment"># &quot;names&quot;: [&quot;ee.x&quot;, &quot;ee.y&quot;, &quot;ee.z&quot;, &quot;ee.wx&quot;, &quot;ee.wy&quot;, &quot;ee.wz&quot;, &quot;ee.gripper_pos&quot;],</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># observation.state_ee</span></span><br><span class="line">new_features[<span class="string">&quot;observation.joint_state&quot;</span>] = &#123;</span><br><span class="line">    <span class="string">&quot;dtype&quot;</span>: <span class="string">&quot;float32&quot;</span>,</span><br><span class="line">    <span class="string">&quot;shape&quot;</span>: (<span class="number">6</span>,),</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;shoulder_pan.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;shoulder_lift.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;elbow_flex.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;wrist_flex.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;wrist_roll.pos&quot;</span>,</span><br><span class="line">                <span class="string">&quot;gripper.pos&quot;</span></span><br><span class="line">            ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>record_loop函数里面，需要让函数知道要加joint
<ol type="1">
<li>新的pipeline <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">identity_teleop_action_processor, identity_robot_action_processor, identity_robot_observation_processor = make_default_processors()</span><br></pre></td></tr></table></figure></li>
<li>给observation增加joint <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># 额外增加state_joint</span></span><br><span class="line">joint_keys = [</span><br><span class="line">    <span class="string">&quot;shoulder_pan.pos&quot;</span>,</span><br><span class="line">    <span class="string">&quot;shoulder_lift.pos&quot;</span>,</span><br><span class="line">    <span class="string">&quot;elbow_flex.pos&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrist_flex.pos&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wrist_roll.pos&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gripper.pos&quot;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> joint_keys:</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">in</span> obs:  <span class="comment"># 确保obs中有这个值</span></span><br><span class="line">        obs_processed[key] = obs[key]</span><br></pre></td></tr></table></figure></li>
</ol></li>
</ol>
<p>执行 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python examples/so100_to_so100_EE/record.py</span><br></pre></td></tr></table></figure></p>
<h2 id="evaluate">evaluate</h2>
<p> the most core work in <code>predict_action</code> function. Where 1.
normalize and to CHW observation 2. preprocessor observation 3. policy
4. post processor policy output ### evaluate.py 1. robot <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">robot = SO100Follower(robot_config)</span><br></pre></td></tr></table></figure>
2. policy <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">policy = SmolVLAPolicy.from_pretrained(HF_MODEL_ID)</span><br></pre></td></tr></table></figure> 3. kinematics solver &amp;
ee-&gt;joints/joints-&gt;ee processor pipeline <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">kinematics_solver = RobotKinematics(</span><br><span class="line">    urdf_path=<span class="string">&quot;SO-ARM100/Simulation/SO101/so101_new_calib.urdf&quot;</span>,</span><br><span class="line">    target_frame_name=<span class="string">&quot;gripper_frame_link&quot;</span>,</span><br><span class="line">    joint_names=<span class="built_in">list</span>(robot.bus.motors.keys()),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build pipeline to convert EE action to joints action</span></span><br><span class="line">robot_ee_to_joints_processor = RobotProcessorPipeline[<span class="built_in">tuple</span>[RobotAction, RobotObservation], RobotAction](</span><br><span class="line">    [</span><br><span class="line">        EEBoundsAndSafety(</span><br><span class="line">            end_effector_bounds=&#123;<span class="string">&quot;min&quot;</span>: [-<span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>], <span class="string">&quot;max&quot;</span>: [<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>]&#125;,</span><br><span class="line">            max_ee_step_m=<span class="number">0.10</span>,</span><br><span class="line">        ),</span><br><span class="line">        InverseKinematicsEEToJoints(</span><br><span class="line">            kinematics=kinematics_solver,</span><br><span class="line">            motor_names=<span class="built_in">list</span>(robot.bus.motors.keys()),</span><br><span class="line">            initial_guess_current_joints=<span class="literal">True</span>,</span><br><span class="line">        ),</span><br><span class="line">    ],</span><br><span class="line">    to_transition=robot_action_observation_to_transition,</span><br><span class="line">    to_output=transition_to_robot_action,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build pipeline to convert joints observation to EE observation</span></span><br><span class="line">robot_joints_to_ee_pose_processor = RobotProcessorPipeline[RobotObservation, RobotObservation](</span><br><span class="line">    steps=[</span><br><span class="line">        ForwardKinematicsJointsToEE(kinematics=kinematics_solver, motor_names=<span class="built_in">list</span>(robot.bus.motors.keys()))</span><br><span class="line">    ],</span><br><span class="line">    to_transition=observation_to_transition,</span><br><span class="line">    to_output=transition_to_observation,</span><br><span class="line">)</span><br></pre></td></tr></table></figure> 4. dataset
to save <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create the dataset</span></span><br><span class="line">dataset = LeRobotDataset.create(</span><br><span class="line">    repo_id=HF_DATASET_ID,</span><br><span class="line">    fps=FPS,</span><br><span class="line">    features=combine_feature_dicts(</span><br><span class="line">        aggregate_pipeline_dataset_features(</span><br><span class="line">            pipeline=robot_joints_to_ee_pose_processor,</span><br><span class="line">            initial_features=create_initial_features(observation=robot.observation_features),</span><br><span class="line">            use_videos=<span class="literal">True</span>,</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment"># User for now should be explicit on the feature keys that were used for record</span></span><br><span class="line">        <span class="comment"># Alternatively, the user can pass the processor step that has the right features</span></span><br><span class="line">        aggregate_pipeline_dataset_features(</span><br><span class="line">            pipeline=make_default_teleop_action_processor(),</span><br><span class="line">            initial_features=create_initial_features(</span><br><span class="line">                action=&#123;</span><br><span class="line">                    <span class="string">f&quot;ee.<span class="subst">&#123;k&#125;</span>&quot;</span>: PolicyFeature(<span class="built_in">type</span>=FeatureType.ACTION, shape=(<span class="number">1</span>,))</span><br><span class="line">                    <span class="keyword">for</span> k <span class="keyword">in</span> [<span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;z&quot;</span>, <span class="string">&quot;wx&quot;</span>, <span class="string">&quot;wy&quot;</span>, <span class="string">&quot;wz&quot;</span>, <span class="string">&quot;gripper_pos&quot;</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            ),</span><br><span class="line">            use_videos=<span class="literal">True</span>,</span><br><span class="line">        ),</span><br><span class="line">    ),</span><br><span class="line">    robot_type=robot.name,</span><br><span class="line">    use_videos=<span class="literal">True</span>,</span><br><span class="line">    image_writer_threads=<span class="number">4</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure> 5. preprocessor, &amp; postprocessor, where
<code>dataset.meta.stats</code> is None since it creates a new dataset
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">preprocessor, postprocessor = make_pre_post_processors(</span><br><span class="line">    policy_cfg=policy,</span><br><span class="line">    pretrained_path=HF_MODEL_ID,</span><br><span class="line">    dataset_stats=dataset.meta.stats,</span><br><span class="line">    <span class="comment"># dataset_stats=None,</span></span><br><span class="line">    <span class="comment"># The inference device is automatically set to match the detected hardware, overriding any previous device settings from training to ensure compatibility.</span></span><br><span class="line">    preprocessor_overrides=&#123;<span class="string">&quot;device_processor&quot;</span>: &#123;<span class="string">&quot;device&quot;</span>: <span class="built_in">str</span>(policy.config.device)&#125;&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure> 6. record_loop <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">record_loop(</span><br><span class="line">        robot=robot,</span><br><span class="line">        events=events,</span><br><span class="line">        fps=FPS,</span><br><span class="line">        policy=policy,</span><br><span class="line">        preprocessor=preprocessor,  <span class="comment"># Pass the pre and post policy processors</span></span><br><span class="line">        postprocessor=postprocessor,</span><br><span class="line">        dataset=dataset,</span><br><span class="line">        control_time_s=EPISODE_TIME_SEC,</span><br><span class="line">        single_task=TASK_DESCRIPTION,</span><br><span class="line">        display_data=<span class="literal">True</span>,</span><br><span class="line">        teleop_action_processor=make_default_teleop_action_processor(), <span class="comment"># 相当于不用管</span></span><br><span class="line">        robot_action_processor=robot_ee_to_joints_processor,</span><br><span class="line">        robot_observation_processor=robot_joints_to_ee_pose_processor,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure> ### record_loop 1.
initialize before every episode <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> policy <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> preprocessor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> postprocessor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">	policy.reset()</span><br><span class="line">	preprocessor.reset()</span><br><span class="line">	postprocessor.reset()</span><br></pre></td></tr></table></figure> 2. get_observation(from
this is a total loop) <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obs = robot.get_observation()       </span><br></pre></td></tr></table></figure> 3. build lerobot type
observation_frame: A "frame" is a dictionary containing all the data for
a single timestep, formatted as numpy arrays according to the feature
specification. <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> policy <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">or</span> dataset <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">	observation_frame = build_dataset_frame(dataset.features, obs_processed, prefix=OBS_STR)</span><br></pre></td></tr></table></figure> 4. get action from policy <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> policy <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> preprocessor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> postprocessor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">  action_values = predict_action(</span><br><span class="line">	  observation=observation_frame,</span><br><span class="line">	  policy=policy,</span><br><span class="line">	  device=get_safe_torch_device(policy.config.device),</span><br><span class="line">	  preprocessor=preprocessor,</span><br><span class="line">	  postprocessor=postprocessor,</span><br><span class="line">	  use_amp=policy.config.use_amp,</span><br><span class="line">	  task=single_task,</span><br><span class="line">	  robot_type=robot.robot_type,</span><br><span class="line">  )</span><br><span class="line">  act_processed_policy: RobotAction = make_robot_action(action_values, dataset.features)</span><br></pre></td></tr></table></figure>
5. calculate joint-space action <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> policy <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> act_processed_policy <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">action_values = act_processed_policy</span><br><span class="line">robot_action_to_send = robot_action_processor((act_processed_policy, obs))</span><br></pre></td></tr></table></figure> 6. send action to robot
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># didn&#x27;t do action clip</span></span><br><span class="line">_sent_action = robot.send_action(robot_action_to_send)</span><br></pre></td></tr></table></figure></p>
<h3 id="predict_action">predict_action</h3>
<p>real observation-&gt;policy-&gt;action. Here <code>observation</code>
is Lerobotdataset type already. In
<code>src/lerobot/utils/control_utils.py</code> As described,it does: 1.
Prepares the observation by converting it to PyTorch tensors and adding
a batch dimension. 2. Runs the preprocessor pipeline on the observation.
3. Feeds the processed observation to the policy to get a raw action. 4.
Runs the postprocessor pipeline on the raw action. 5. Formats the final
action by removing the batch dimension and moving it to the CPU. Finaly
returns: A <code>torch.Tensor</code> containing the predicted action,
ready for the robot.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">predict_action</span>(<span class="params"></span></span><br><span class="line"><span class="params">    observation: <span class="built_in">dict</span>[<span class="built_in">str</span>, np.ndarray],</span></span><br><span class="line"><span class="params">    policy: PreTrainedPolicy,</span></span><br><span class="line"><span class="params">    preprocessor: PolicyProcessorPipeline[<span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]],</span></span><br><span class="line"><span class="params">    postprocessor: PolicyProcessorPipeline[PolicyAction, PolicyAction],</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    observation = copy(observation)</span><br><span class="line">    <span class="keyword">with</span> (</span><br><span class="line">        torch.inference_mode(),</span><br><span class="line">        torch.autocast(device_type=device.<span class="built_in">type</span>) <span class="keyword">if</span> device.<span class="built_in">type</span> == <span class="string">&quot;cuda&quot;</span> <span class="keyword">and</span> use_amp <span class="keyword">else</span> nullcontext(),</span><br><span class="line">    ):</span><br><span class="line">        <span class="comment"># Convert to pytorch format: channel first and float32 in [0,1] with batch dimension</span></span><br><span class="line">        observation = prepare_observation_for_inference(observation, device, task, robot_type)</span><br><span class="line">        observation = preprocessor(observation)</span><br><span class="line">        action = policy.select_action(observation)</span><br><span class="line">        action = postprocessor(action)</span><br><span class="line">    <span class="keyword">return</span> action</span><br></pre></td></tr></table></figure>
<p>prepare_observation_for_inference takes a dictionary of NumPy arrays,
performs necessary preprocessing, and prepares it for model inference.
The steps include: 1. Converting NumPy arrays to PyTorch tensors. 2.
Normalizing and permuting image data (if any). 3. Adding a batch
dimension to each tensor. 4. Moving all tensors to the specified compute
device. <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_observation_for_inference</span>(<span class="params"></span></span><br><span class="line"><span class="params">    observation: <span class="built_in">dict</span>[<span class="built_in">str</span>, np.ndarray],</span></span><br><span class="line"><span class="params">    device: torch.device,</span></span><br><span class="line"><span class="params"></span>) -&gt; RobotObservation:</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> observation:</span><br><span class="line">        observation[name] = torch.from_numpy(observation[name])</span><br><span class="line">        <span class="comment"># image process: /255 and to CHW</span></span><br><span class="line">         <span class="keyword">if</span> <span class="string">&quot;image&quot;</span> <span class="keyword">in</span> name:</span><br><span class="line">            observation[name] = observation[name].<span class="built_in">type</span>(torch.float32) / <span class="number">255</span></span><br><span class="line">            observation[name] = observation[name].permute(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>).contiguous()</span><br><span class="line">        observation[name] = observation[name].unsqueeze(<span class="number">0</span>)</span><br><span class="line">        observation[name] = observation[name].to(device)</span><br><span class="line">    <span class="keyword">return</span> observation</span><br></pre></td></tr></table></figure></p>
<h3 id="local">local</h3>
<h3 id="async">async</h3>
<ul class="task-list">
<li><label><input
type="checkbox" />async以前的结构：改变输入和输出的action在哪里</label></li>
<li><label><input type="checkbox" />本地</label></li>
<li><label><input type="checkbox" />服务器 #### ee推理代码 主函数调用：
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># Main record loop</span></span><br><span class="line">    record_loop(</span><br><span class="line">        teleop_action_processor=make_default_teleop_action_processor(),</span><br><span class="line">        robot_action_processor=robot_ee_to_joints_processor,</span><br><span class="line">        robot_observation_processor=robot_joints_to_ee_pose_processor,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
[[#record_loop函数]]里面，action利用<code>robot_action_to_send = robot_action_processor((act_processed_policy, obs))</code>处理。ee推理里面定义为<code>robot_ee_to_joints_processor</code></label></li>
<li><label><input
type="checkbox" />所以改代码就要给async的action另外处理，判断条件就用name里面是否包含ee</label></li>
</ul>
<h4 id="修改async">修改async</h4>
<p>根据[[#async]]，直接修改本地接收到action之后的执行，在那之前加上action
pipeline+处理传给policy之前的state。
在robot_client_ee.py（和robot_client.py一样，改class名） 1.
init函数里增加ee和joint转换的工具 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># solver</span></span><br><span class="line">kinematics_solver = RobotKinematics(</span><br><span class="line">    urdf_path=<span class="string">&quot;SO-ARM100/Simulation/SO101/so101_new_calib.urdf&quot;</span>,</span><br><span class="line">    target_frame_name=<span class="string">&quot;gripper_frame_link&quot;</span>,</span><br><span class="line">    joint_names=<span class="built_in">list</span>(robot.bus.motors.keys()),</span><br><span class="line">)</span><br><span class="line">    <span class="comment"># ee到joint</span></span><br><span class="line">robot_ee_to_joints_processor = RobotProcessorPipeline[<span class="built_in">tuple</span>[RobotAction, RobotObservation], RobotAction](</span><br><span class="line">    steps=[</span><br><span class="line">        InverseKinematicsEEToJoints(</span><br><span class="line">            kinematics=kinematics_solver,</span><br><span class="line">            motor_names=<span class="built_in">list</span>(robot.bus.motors.keys()),</span><br><span class="line">            initial_guess_current_joints=<span class="literal">True</span>,</span><br><span class="line">        ),</span><br><span class="line">    ],</span><br><span class="line">    EEBoundsAndSafety(</span><br><span class="line">        end_effector_bounds=&#123;<span class="string">&quot;min&quot;</span>: [-<span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>], <span class="string">&quot;max&quot;</span>: [<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>]&#125;,</span><br><span class="line">        max_ee_step_m=<span class="number">0.10</span>,</span><br><span class="line">    ),</span><br><span class="line">    to_transition=robot_action_observation_to_transition,</span><br><span class="line">    to_output=transition_to_robot_action,</span><br><span class="line">)</span><br><span class="line">    <span class="comment"># joint到ee</span></span><br><span class="line">robot_joints_to_ee_pose_processor = RobotProcessorPipeline[RobotObservation, RobotObservation](</span><br><span class="line">    steps=[</span><br><span class="line">        ForwardKinematicsJointsToEE(kinematics=kinematics_solver, motor_names=<span class="built_in">list</span>(robot.bus.motors.keys()))</span><br><span class="line">    ],</span><br><span class="line">    to_transition=observation_to_transition,</span><br><span class="line">    to_output=transition_to_observation,</span><br><span class="line">)</span><br></pre></td></tr></table></figure> 2.
发给server的state从joint变成ee
control_loop_observation函数里给raw_obs处理成<code>ee_obs = self.joints_to_ee(raw_observation)</code>
3. server返回的action从ee变成joint，control_loop_action函数里把
<code>_performed_action = self.robot.send_action(self._action_tensor_to_action_dict(timed_action.get_action()))</code>替换成
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ee_action = self._action_tensor_to_action_dict(timed_action.get_action())</span><br><span class="line">joint_action = self.ee_to_follower_joints((ee_action, self.latest_joint_observation))</span><br><span class="line">_performed_action = self.robot.send_action(joint_action)</span><br></pre></td></tr></table></figure> 4.
<code>self.latest_joint_observation</code>应该是joint形式，保持不变，因为之前没有修改它
5. 修改feature 1.
这个feature要求和什么一致？RemotePolicyConfig里面传给服务器self.lerobot_features
= policy_specs.lerobot_features 2. 原来的形式：{'observation.state':
{'dtype': 'float32', 'shape': (6,), 'names': ['shoulder_pan.pos',
'shoulder_lift.pos', 'elbow_flex.pos', 'wrist_flex.pos',
'wrist_roll.pos', 'gripper.pos']}} 3. 应该要的形式：'observation.state':
{'dtype': 'float32', 'shape': (7,), 'names': ['ee.x', 'ee.y', 'ee.z',
'ee.wx', 'ee.wy', 'ee.wz', 'ee.gripper_pos']} 4. 最终的修改方案 1.
lerobot_features_ee_state['observation.state']=ee_feature['observation.state']
2.</p>
<h4 id="async执行">async执行</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 666 /dev/ttyACM0</span><br><span class="line">python -m lerobot.async_inference.robot_client_ee \</span><br><span class="line">    --robot.type=so100_follower \</span><br><span class="line">    --robot.port=/dev/ttyACM0 \</span><br><span class="line">    --robot.id=follower \</span><br><span class="line">    --task=&quot;dummy&quot; \</span><br><span class="line">    --server_address=127.0.0.1:8080 \</span><br><span class="line">    --policy_type=act \</span><br><span class="line">    --pretrained_name_or_path=user/model \</span><br><span class="line">    --policy_device=mps \</span><br><span class="line">    --actions_per_chunk=50 \</span><br><span class="line">    --chunk_size_threshold=0.5 \</span><br><span class="line">    --aggregate_fn_name=weighted_average \</span><br><span class="line">    --debug_visualize_queue_size=False</span><br></pre></td></tr></table></figure>
<h4 id="执行">执行</h4>
<p>服务器端 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HF_HUB_OFFLINE=1 CUDA_VISIBLE_DEVICES=0 python -m lerobot.async_inference.policy_server \</span><br><span class="line">     --host=10.10.16.18 \</span><br><span class="line">     --port=8080 \</span><br><span class="line">     --fps=30 \</span><br><span class="line">     --inference_latency=0.033 \</span><br><span class="line">     --obs_queue_timeout=1</span><br></pre></td></tr></table></figure></p>
<p>客户端，还是用yaml的形式不然太难看了。另外有一个之前没有注意的参数
robot里面的use_degrees，这个参数是用来告诉 当前新版硬件 API：
你传入和读出的关节位置是否使用“度数（degrees）”，还是使用新版统一的“归一化范围（–100…100）”。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test.yaml</span></span><br><span class="line"><span class="attr">server_address:</span> <span class="number">10.10</span><span class="number">.16</span><span class="number">.18</span><span class="string">:8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">robot:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">so100_follower</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">/dev/ttyACM0</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">follower</span></span><br><span class="line">  <span class="attr">cameras:</span></span><br><span class="line">    <span class="attr">camera1:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">intelrealsense</span></span><br><span class="line">      <span class="attr">serial_number_or_name:</span> <span class="number">806312060427</span></span><br><span class="line">      <span class="attr">width:</span> <span class="number">640</span></span><br><span class="line">      <span class="attr">height:</span> <span class="number">480</span></span><br><span class="line">      <span class="attr">fps:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">use_depth:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">camera2:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">opencv</span></span><br><span class="line">      <span class="attr">index_or_path:</span> <span class="number">6</span></span><br><span class="line">      <span class="attr">width:</span> <span class="number">640</span></span><br><span class="line">      <span class="attr">height:</span> <span class="number">480</span></span><br><span class="line">      <span class="attr">fps:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="attr">task:</span> <span class="string">pick</span> <span class="string">up</span> <span class="string">the</span> <span class="string">yellow</span> <span class="string">sachet</span> <span class="string">and</span> <span class="string">place</span> <span class="string">it</span> <span class="string">into</span> <span class="string">the</span> <span class="string">box.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">policy_type:</span> <span class="string">smolvla</span></span><br><span class="line"><span class="attr">pretrained_name_or_path:</span> <span class="string">outputs/train/ee_action_ee_state/checkpoints/020000/pretrained_model&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">actions_per_chunk:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">chunk_size_threshold:</span> <span class="number">0.5</span></span><br><span class="line"><span class="attr">aggregate_fn_name:</span> <span class="string">weighted_average</span></span><br><span class="line"><span class="attr">debug_visualize_queue_size:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>执行 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HF_HUB_OFFLINE=1 python -m lerobot.async_inference.robot_client_ee --config_path=local_tools/eva/test.yaml</span><br></pre></td></tr></table></figure></p>
<p>有一个新问题，就是服务器端和本地真正执行predict的时候input不一样，因为async有给图片做和policy一致的resize
所以服务器里面最好加上dataset.meta.stats,</p>
<h4 id="时间问题">时间问题</h4>
<p>服务器推理send_action能不能send完全？ 1. robot_client的代码 它
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RobotClient</span>:</span><br><span class="line">    prefix = <span class="string">&quot;robot_client&quot;</span></span><br><span class="line">    logger = get_logger(prefix)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: RobotClientConfig</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Initialize RobotClient with unified configuration.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            config: RobotClientConfig containing all configuration parameters</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Store configuration</span></span><br><span class="line">        self.config = config</span><br><span class="line">        self.robot = make_robot_from_config(config.robot)</span><br><span class="line">        self.robot.connect()</span><br><span class="line"></span><br><span class="line">        lerobot_features = map_robot_keys_to_lerobot_features(self.robot)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Use environment variable if server_address is not provided in config</span></span><br><span class="line">        self.server_address = config.server_address</span><br><span class="line"></span><br><span class="line">        self.policy_config = RemotePolicyConfig(</span><br><span class="line">            config.policy_type,</span><br><span class="line">            config.pretrained_name_or_path,</span><br><span class="line">            lerobot_features,</span><br><span class="line">            config.actions_per_chunk,</span><br><span class="line">            config.policy_device,</span><br><span class="line">        )</span><br><span class="line">        self.channel = grpc.insecure_channel(</span><br><span class="line">            self.server_address, grpc_channel_options(initial_backoff=<span class="string">f&quot;<span class="subst">&#123;config.environment_dt:<span class="number">.4</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        self.stub = services_pb2_grpc.AsyncInferenceStub(self.channel)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.shutdown_event = threading.Event()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Initialize client side variables</span></span><br><span class="line">        self.latest_action_lock = threading.Lock()</span><br><span class="line">        self.latest_action = -<span class="number">1</span></span><br><span class="line">        self.action_chunk_size = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">        self._chunk_size_threshold = config.chunk_size_threshold</span><br><span class="line">        self.action_queue = Queue()</span><br><span class="line">        self.action_queue_lock = threading.Lock()  <span class="comment"># Protect queue operations</span></span><br><span class="line">        self.action_queue_size = []</span><br><span class="line">        self.start_barrier = threading.Barrier(<span class="number">2</span>)  <span class="comment"># 2 threads: action receiver, control loop</span></span><br><span class="line">        <span class="comment"># FPS measurement</span></span><br><span class="line">        self.fps_tracker = FPSTracker(target_fps=self.config.fps)</span><br><span class="line">        <span class="comment"># Use an event for thread-safe coordination</span></span><br><span class="line">        self.must_go = threading.Event()</span><br><span class="line">        self.must_go.<span class="built_in">set</span>()  <span class="comment"># Initially set - observations qualify for direct processing</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">running</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> self.shutdown_event.is_set()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Start the robot client and connect to the policy server&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># client-server handshake</span></span><br><span class="line">            start_time = time.perf_counter()</span><br><span class="line">            self.stub.Ready(services_pb2.Empty())</span><br><span class="line">            end_time = time.perf_counter()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># send policy instructions</span></span><br><span class="line">            policy_config_bytes = pickle.dumps(self.policy_config)</span><br><span class="line">            policy_setup = services_pb2.PolicySetup(data=policy_config_bytes)</span><br><span class="line">            self.stub.SendPolicyInstructions(policy_setup)</span><br><span class="line">            self.shutdown_event.clear()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> grpc.RpcError <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;Failed to connect to policy server: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Stop the robot client&quot;&quot;&quot;</span></span><br><span class="line">        self.shutdown_event.<span class="built_in">set</span>()</span><br><span class="line">        self.robot.disconnect()</span><br><span class="line">        self.channel.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_observation</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        obs: TimedObservation,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Send observation to the policy server.</span></span><br><span class="line"><span class="string">        Returns True if the observation was sent successfully, False otherwise.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.running:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Client not running. Run RobotClient.start() before sending observations.&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(obs, TimedObservation):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Input observation needs to be a TimedObservation!&quot;</span>)</span><br><span class="line">        start_time = time.perf_counter()</span><br><span class="line">        observation_bytes = pickle.dumps(obs)</span><br><span class="line">        serialize_time = time.perf_counter() - start_time</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            observation_iterator = send_bytes_in_chunks(</span><br><span class="line">                observation_bytes,</span><br><span class="line">                services_pb2.Observation,</span><br><span class="line">                log_prefix=<span class="string">&quot;[CLIENT] Observation&quot;</span>,</span><br><span class="line">                silent=<span class="literal">True</span>,</span><br><span class="line">            )</span><br><span class="line">            _ = self.stub.SendObservations(observation_iterator)</span><br><span class="line">            obs_timestep = obs.get_timestep()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> grpc.RpcError <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;Error sending observation #<span class="subst">&#123;obs.get_timestep()&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_inspect_action_queue</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> self.action_queue_lock:</span><br><span class="line">            queue_size = self.action_queue.qsize()</span><br><span class="line">            timestamps = <span class="built_in">sorted</span>([action.get_timestep() <span class="keyword">for</span> action <span class="keyword">in</span> self.action_queue.queue])</span><br><span class="line">        <span class="keyword">return</span> queue_size, timestamps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_aggregate_action_queues</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        incoming_actions: <span class="built_in">list</span>[TimedAction],</span></span><br><span class="line"><span class="params">        aggregate_fn: <span class="type">Callable</span>[[torch.Tensor, torch.Tensor], torch.Tensor] | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Finds the same timestep actions in the queue and aggregates them using the aggregate_fn&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> aggregate_fn <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># default aggregate function: take the latest action</span></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">aggregate_fn</span>(<span class="params">x1, x2</span>):</span><br><span class="line">                <span class="keyword">return</span> x2</span><br><span class="line"></span><br><span class="line">        future_action_queue = Queue()</span><br><span class="line">        <span class="keyword">with</span> self.action_queue_lock:</span><br><span class="line">            internal_queue = self.action_queue.queue</span><br><span class="line"></span><br><span class="line">        current_action_queue = &#123;action.get_timestep(): action.get_action() <span class="keyword">for</span> action <span class="keyword">in</span> internal_queue&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> new_action <span class="keyword">in</span> incoming_actions:</span><br><span class="line">            <span class="keyword">with</span> self.latest_action_lock:</span><br><span class="line">                latest_action = self.latest_action</span><br><span class="line"></span><br><span class="line">            <span class="comment"># New action is older than the latest action in the queue, skip it</span></span><br><span class="line">            <span class="keyword">if</span> new_action.get_timestep() &lt;= latest_action:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># If the new action&#x27;s timestep is not in the current action queue, add it directly</span></span><br><span class="line">            <span class="keyword">elif</span> new_action.get_timestep() <span class="keyword">not</span> <span class="keyword">in</span> current_action_queue:</span><br><span class="line">                future_action_queue.put(new_action)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># If the new action&#x27;s timestep is in the current action queue, aggregate it</span></span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> There is probably a way to do this with broadcasting of the two action tensors</span></span><br><span class="line">            future_action_queue.put(</span><br><span class="line">                TimedAction(</span><br><span class="line">                    timestamp=new_action.get_timestamp(),</span><br><span class="line">                    timestep=new_action.get_timestep(),</span><br><span class="line">                    action=aggregate_fn(</span><br><span class="line">                        current_action_queue[new_action.get_timestep()], new_action.get_action()</span><br><span class="line">                    ),</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> self.action_queue_lock:</span><br><span class="line">            self.action_queue = future_action_queue</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">receive_actions</span>(<span class="params">self, verbose: <span class="built_in">bool</span> = <span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Receive actions from the policy server&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Wait at barrier for synchronized start</span></span><br><span class="line">        self.start_barrier.wait()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> self.running:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Use StreamActions to get a stream of actions from the server</span></span><br><span class="line">                actions_chunk = self.stub.GetActions(services_pb2.Empty())</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(actions_chunk.data) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">continue</span>  <span class="comment"># received `Empty` from server, wait for next call</span></span><br><span class="line"></span><br><span class="line">                receive_time = time.time()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Deserialize bytes back into list[TimedAction]</span></span><br><span class="line">                deserialize_start = time.perf_counter()</span><br><span class="line">                timed_actions = pickle.loads(actions_chunk.data)  <span class="comment"># nosec</span></span><br><span class="line">                deserialize_time = time.perf_counter() - deserialize_start</span><br><span class="line"></span><br><span class="line">                self.action_chunk_size = <span class="built_in">max</span>(self.action_chunk_size, <span class="built_in">len</span>(timed_actions))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Calculate network latency if we have matching observations</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(timed_actions) &gt; <span class="number">0</span> <span class="keyword">and</span> verbose:</span><br><span class="line">                    <span class="keyword">with</span> self.latest_action_lock:</span><br><span class="line">                        latest_action = self.latest_action</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Get queue state before changes</span></span><br><span class="line">                    old_size, old_timesteps = self._inspect_action_queue()</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> old_timesteps:</span><br><span class="line">                        old_timesteps = [latest_action]  <span class="comment"># queue was empty</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Log incoming actions</span></span><br><span class="line">                    incoming_timesteps = [a.get_timestep() <span class="keyword">for</span> a <span class="keyword">in</span> timed_actions]</span><br><span class="line"></span><br><span class="line">                    first_action_timestep = timed_actions[<span class="number">0</span>].get_timestep()</span><br><span class="line">                    server_to_client_latency = (receive_time - timed_actions[<span class="number">0</span>].get_timestamp()) * <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Update action queue</span></span><br><span class="line">                start_time = time.perf_counter()</span><br><span class="line">                self._aggregate_action_queues(timed_actions, self.config.aggregate_fn)</span><br><span class="line">                queue_update_time = time.perf_counter() - start_time</span><br><span class="line"></span><br><span class="line">                self.must_go.<span class="built_in">set</span>()  <span class="comment"># after receiving actions, next empty queue triggers must-go processing!</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> verbose:</span><br><span class="line">                    <span class="comment"># Get queue state after changes</span></span><br><span class="line">                    new_size, new_timesteps = self._inspect_action_queue()</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">with</span> self.latest_action_lock:</span><br><span class="line">                        latest_action = self.latest_action</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> grpc.RpcError <span class="keyword">as</span> e:</span><br><span class="line">                self.logger.error(<span class="string">f&quot;Error receiving actions: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">actions_available</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Check if there are actions available in the queue&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.action_queue_lock:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">not</span> self.action_queue.empty()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_action_tensor_to_action_dict</span>(<span class="params">self, action_tensor: torch.Tensor</span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        action = &#123;key: action_tensor[i].item() <span class="keyword">for</span> i, key <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.robot.action_features)&#125;</span><br><span class="line">        <span class="keyword">return</span> action</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">control_loop_action</span>(<span class="params">self, verbose: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Reading and performing actions in local queue&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Lock only for queue operations</span></span><br><span class="line">        get_start = time.perf_counter()</span><br><span class="line">        <span class="keyword">with</span> self.action_queue_lock:</span><br><span class="line">            self.action_queue_size.append(self.action_queue.qsize())</span><br><span class="line">            <span class="comment"># Get action from queue</span></span><br><span class="line">            timed_action = self.action_queue.get_nowait()</span><br><span class="line">        get_end = time.perf_counter() - get_start</span><br><span class="line"></span><br><span class="line">        _performed_action = self.robot.send_action(</span><br><span class="line">            self._action_tensor_to_action_dict(timed_action.get_action())</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">with</span> self.latest_action_lock:</span><br><span class="line">            self.latest_action = timed_action.get_timestep()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _performed_action</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_ready_to_send_observation</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Flags when the client is ready to send an observation&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> self.action_queue_lock:</span><br><span class="line">            <span class="keyword">return</span> self.action_queue.qsize() / self.action_chunk_size &lt;= self._chunk_size_threshold</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">control_loop_observation</span>(<span class="params">self, task: <span class="built_in">str</span>, verbose: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; RawObservation:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Get serialized observation bytes from the function</span></span><br><span class="line">            start_time = time.perf_counter()</span><br><span class="line"></span><br><span class="line">            raw_observation: RawObservation = self.robot.get_observation()</span><br><span class="line">            raw_observation[<span class="string">&quot;task&quot;</span>] = task</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> self.latest_action_lock:</span><br><span class="line">                latest_action = self.latest_action</span><br><span class="line"></span><br><span class="line">            observation = TimedObservation(</span><br><span class="line">                timestamp=time.time(),  <span class="comment"># need time.time() to compare timestamps across client and server</span></span><br><span class="line">                observation=raw_observation,</span><br><span class="line">                timestep=<span class="built_in">max</span>(latest_action, <span class="number">0</span>),</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            obs_capture_time = time.perf_counter() - start_time</span><br><span class="line"></span><br><span class="line">            <span class="comment"># If there are no actions left in the queue, the observation must go through processing!</span></span><br><span class="line">            <span class="keyword">with</span> self.action_queue_lock:</span><br><span class="line">                observation.must_go = self.must_go.is_set() <span class="keyword">and</span> self.action_queue.empty()</span><br><span class="line">                current_queue_size = self.action_queue.qsize()</span><br><span class="line"></span><br><span class="line">            _ = self.send_observation(observation)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> observation.must_go:</span><br><span class="line">                <span class="comment"># must-go event will be set again after receiving actions</span></span><br><span class="line">                self.must_go.clear()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> raw_observation</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;Error in observation sender: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">control_loop</span>(<span class="params">self, task: <span class="built_in">str</span>, verbose: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; <span class="built_in">tuple</span>[Observation, Action]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Combined function for executing actions and streaming observations&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Wait at barrier for synchronized start</span></span><br><span class="line">        self.start_barrier.wait()</span><br><span class="line"></span><br><span class="line">        _performed_action = <span class="literal">None</span></span><br><span class="line">        _captured_observation = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> self.running:</span><br><span class="line">            control_loop_start = time.perf_counter()</span><br><span class="line">            <span class="string">&quot;&quot;&quot;Control loop: (1) Performing actions, when available&quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> self.actions_available():</span><br><span class="line">                _performed_action = self.control_loop_action(verbose)</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;&quot;&quot;Control loop: (2) Streaming observations to the remote policy server&quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> self._ready_to_send_observation():</span><br><span class="line">                _captured_observation = self.control_loop_observation(task, verbose)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Dynamically adjust sleep time to maintain the desired control frequency</span></span><br><span class="line">            time.sleep(<span class="built_in">max</span>(<span class="number">0</span>, self.config.environment_dt - (time.perf_counter() - control_loop_start)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _captured_observation, _performed_action</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@draccus.wrap()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">async_client</span>(<span class="params">cfg: RobotClientConfig</span>):</span><br><span class="line">    logging.info(pformat(asdict(cfg)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cfg.robot.<span class="built_in">type</span> <span class="keyword">not</span> <span class="keyword">in</span> SUPPORTED_ROBOTS:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Robot <span class="subst">&#123;cfg.robot.<span class="built_in">type</span>&#125;</span> not yet supported!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    client = RobotClient(cfg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> client.start():</span><br><span class="line">        client.logger.info(<span class="string">&quot;Starting action receiver thread...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create and start action receiver thread</span></span><br><span class="line">        action_receiver_thread = threading.Thread(target=client.receive_actions, daemon=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Start action receiver thread</span></span><br><span class="line">        action_receiver_thread.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># The main thread runs the control loop</span></span><br><span class="line">            client.control_loop(task=cfg.task)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            client.stop()</span><br><span class="line">            action_receiver_thread.join()</span><br><span class="line">            <span class="keyword">if</span> cfg.debug_visualize_queue_size:</span><br><span class="line">                visualize_action_queue_size(client.action_queue_size)</span><br><span class="line">            client.logger.info(<span class="string">&quot;Client stopped&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    async_client()  <span class="comment"># run the client</span></span><br></pre></td></tr></table></figure> 2. send_action用的什么原理 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SO100Follower</span>(<span class="title class_ inherited__">Robot</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    [SO-100 Follower Arm](https://github.com/TheRobotStudio/SO-ARM100) designed by TheRobotStudio</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    config_class = SO100FollowerConfig</span><br><span class="line">    name = <span class="string">&quot;so100_follower&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: SO100FollowerConfig</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(config)</span><br><span class="line">        self.config = config</span><br><span class="line">        norm_mode_body = MotorNormMode.DEGREES <span class="keyword">if</span> config.use_degrees <span class="keyword">else</span> MotorNormMode.RANGE_M100_100</span><br><span class="line">        self.bus = FeetechMotorsBus(</span><br><span class="line">            port=self.config.port,</span><br><span class="line">            motors=&#123;</span><br><span class="line">                <span class="string">&quot;shoulder_pan&quot;</span>: Motor(<span class="number">1</span>, <span class="string">&quot;sts3215&quot;</span>, norm_mode_body),</span><br><span class="line">                <span class="string">&quot;shoulder_lift&quot;</span>: Motor(<span class="number">2</span>, <span class="string">&quot;sts3215&quot;</span>, norm_mode_body),</span><br><span class="line">                <span class="string">&quot;elbow_flex&quot;</span>: Motor(<span class="number">3</span>, <span class="string">&quot;sts3215&quot;</span>, norm_mode_body),</span><br><span class="line">                <span class="string">&quot;wrist_flex&quot;</span>: Motor(<span class="number">4</span>, <span class="string">&quot;sts3215&quot;</span>, norm_mode_body),</span><br><span class="line">                <span class="string">&quot;wrist_roll&quot;</span>: Motor(<span class="number">5</span>, <span class="string">&quot;sts3215&quot;</span>, norm_mode_body),</span><br><span class="line">                <span class="string">&quot;gripper&quot;</span>: Motor(<span class="number">6</span>, <span class="string">&quot;sts3215&quot;</span>, MotorNormMode.RANGE_0_100),</span><br><span class="line">            &#125;,</span><br><span class="line">            calibration=self.calibration,</span><br><span class="line">        )</span><br><span class="line">        self.cameras = make_cameras_from_configs(config.cameras)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="meta">    @cached_property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">observation_features</span>(<span class="params">self</span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">type</span> | <span class="built_in">tuple</span>]:</span><br><span class="line">        <span class="keyword">return</span> &#123;**self._motors_ft, **self._cameras_ft&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @cached_property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">action_features</span>(<span class="params">self</span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">type</span>]:</span><br><span class="line">        <span class="keyword">return</span> self._motors_ft</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_connected</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> self.bus.is_connected <span class="keyword">and</span> <span class="built_in">all</span>(cam.is_connected <span class="keyword">for</span> cam <span class="keyword">in</span> self.cameras.values())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self, calibrate: <span class="built_in">bool</span> = <span class="literal">True</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        We assume that at connection time, arm is in a rest position,</span></span><br><span class="line"><span class="string">        and torque can be safely disabled to run calibration.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.is_connected:</span><br><span class="line">            <span class="keyword">raise</span> DeviceAlreadyConnectedError(<span class="string">f&quot;<span class="subst">&#123;self&#125;</span> already connected&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.bus.connect()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_calibrated <span class="keyword">and</span> calibrate:</span><br><span class="line">            logger.info(</span><br><span class="line">                <span class="string">&quot;Mismatch between calibration values in the motor and the calibration file or no calibration file found&quot;</span></span><br><span class="line">            )</span><br><span class="line">            self.calibrate()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> cam <span class="keyword">in</span> self.cameras.values():</span><br><span class="line">            cam.connect()</span><br><span class="line"></span><br><span class="line">        self.configure()</span><br><span class="line">        logger.info(<span class="string">f&quot;<span class="subst">&#123;self&#125;</span> connected.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_calibrated</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> self.bus.is_calibrated</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calibrate</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> self.calibration:</span><br><span class="line">            <span class="comment"># Calibration file exists, ask user whether to use it or run new calibration</span></span><br><span class="line">            user_input = <span class="built_in">input</span>(</span><br><span class="line">                <span class="string">f&quot;Press ENTER to use provided calibration file associated with the id <span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, or type &#x27;c&#x27; and press ENTER to run calibration: &quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> user_input.strip().lower() != <span class="string">&quot;c&quot;</span>:</span><br><span class="line">                logger.info(<span class="string">f&quot;Writing calibration file associated with the id <span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span> to the motors&quot;</span>)</span><br><span class="line">                self.bus.write_calibration(self.calibration)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">f&quot;\nRunning calibration of <span class="subst">&#123;self&#125;</span>&quot;</span>)</span><br><span class="line">        self.bus.disable_torque()</span><br><span class="line">        <span class="keyword">for</span> motor <span class="keyword">in</span> self.bus.motors:</span><br><span class="line">            self.bus.write(<span class="string">&quot;Operating_Mode&quot;</span>, motor, OperatingMode.POSITION.value)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">input</span>(<span class="string">f&quot;Move <span class="subst">&#123;self&#125;</span> to the middle of its range of motion and press ENTER....&quot;</span>)</span><br><span class="line">        homing_offsets = self.bus.set_half_turn_homings()</span><br><span class="line"></span><br><span class="line">        full_turn_motor = <span class="string">&quot;wrist_roll&quot;</span></span><br><span class="line">        unknown_range_motors = [motor <span class="keyword">for</span> motor <span class="keyword">in</span> self.bus.motors <span class="keyword">if</span> motor != full_turn_motor]</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">f&quot;Move all joints except &#x27;<span class="subst">&#123;full_turn_motor&#125;</span>&#x27; sequentially through their &quot;</span></span><br><span class="line">            <span class="string">&quot;entire ranges of motion.\nRecording positions. Press ENTER to stop...&quot;</span></span><br><span class="line">        )</span><br><span class="line">        range_mins, range_maxes = self.bus.record_ranges_of_motion(unknown_range_motors)</span><br><span class="line">        range_mins[full_turn_motor] = <span class="number">0</span></span><br><span class="line">        range_maxes[full_turn_motor] = <span class="number">4095</span></span><br><span class="line"></span><br><span class="line">        self.calibration = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> motor, m <span class="keyword">in</span> self.bus.motors.items():</span><br><span class="line">            self.calibration[motor] = MotorCalibration(</span><br><span class="line">                <span class="built_in">id</span>=m.<span class="built_in">id</span>,</span><br><span class="line">                drive_mode=<span class="number">0</span>,</span><br><span class="line">                homing_offset=homing_offsets[motor],</span><br><span class="line">                range_min=range_mins[motor],</span><br><span class="line">                range_max=range_maxes[motor],</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        self.bus.write_calibration(self.calibration)</span><br><span class="line">        self._save_calibration()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Calibration saved to&quot;</span>, self.calibration_fpath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">configure</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">with</span> self.bus.torque_disabled():</span><br><span class="line">            self.bus.configure_motors()</span><br><span class="line">            <span class="keyword">for</span> motor <span class="keyword">in</span> self.bus.motors:</span><br><span class="line">                self.bus.write(<span class="string">&quot;Operating_Mode&quot;</span>, motor, OperatingMode.POSITION.value)</span><br><span class="line">                <span class="comment"># Set P_Coefficient to lower value to avoid shakiness (Default is 32)</span></span><br><span class="line">                self.bus.write(<span class="string">&quot;P_Coefficient&quot;</span>, motor, <span class="number">16</span>)</span><br><span class="line">                <span class="comment"># Set I_Coefficient and D_Coefficient to default value 0 and 32</span></span><br><span class="line">                self.bus.write(<span class="string">&quot;I_Coefficient&quot;</span>, motor, <span class="number">0</span>)</span><br><span class="line">                self.bus.write(<span class="string">&quot;D_Coefficient&quot;</span>, motor, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> motor == <span class="string">&quot;gripper&quot;</span>:</span><br><span class="line">                    self.bus.write(<span class="string">&quot;Max_Torque_Limit&quot;</span>, motor, <span class="number">500</span>)  <span class="comment"># 50% of max torque to avoid burnout</span></span><br><span class="line">                    self.bus.write(<span class="string">&quot;Protection_Current&quot;</span>, motor, <span class="number">250</span>)  <span class="comment"># 50% of max current to avoid burnout</span></span><br><span class="line">                    self.bus.write(<span class="string">&quot;Overload_Torque&quot;</span>, motor, <span class="number">25</span>)  <span class="comment"># 25% torque when overloaded</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_motors</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> motor <span class="keyword">in</span> <span class="built_in">reversed</span>(self.bus.motors):</span><br><span class="line">            <span class="built_in">input</span>(<span class="string">f&quot;Connect the controller board to the &#x27;<span class="subst">&#123;motor&#125;</span>&#x27; motor only and press enter.&quot;</span>)</span><br><span class="line">            self.bus.setup_motor(motor)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;&#x27;<span class="subst">&#123;motor&#125;</span>&#x27; motor id set to <span class="subst">&#123;self.bus.motors[motor].<span class="built_in">id</span>&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_observation</span>(<span class="params">self</span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_connected:</span><br><span class="line">            <span class="keyword">raise</span> DeviceNotConnectedError(<span class="string">f&quot;<span class="subst">&#123;self&#125;</span> is not connected.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Read arm position</span></span><br><span class="line">        start = time.perf_counter()</span><br><span class="line">        obs_dict = self.bus.sync_read(<span class="string">&quot;Present_Position&quot;</span>)</span><br><span class="line">        obs_dict = &#123;<span class="string">f&quot;<span class="subst">&#123;motor&#125;</span>.pos&quot;</span>: val <span class="keyword">for</span> motor, val <span class="keyword">in</span> obs_dict.items()&#125;</span><br><span class="line">        dt_ms = (time.perf_counter() - start) * <span class="number">1e3</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;<span class="subst">&#123;self&#125;</span> read state: <span class="subst">&#123;dt_ms:<span class="number">.1</span>f&#125;</span>ms&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Capture images from cameras</span></span><br><span class="line">        <span class="keyword">for</span> cam_key, cam <span class="keyword">in</span> self.cameras.items():</span><br><span class="line">            start = time.perf_counter()</span><br><span class="line">            obs_dict[cam_key] = cam.async_read()</span><br><span class="line">            dt_ms = (time.perf_counter() - start) * <span class="number">1e3</span></span><br><span class="line">            logger.debug(<span class="string">f&quot;<span class="subst">&#123;self&#125;</span> read <span class="subst">&#123;cam_key&#125;</span>: <span class="subst">&#123;dt_ms:<span class="number">.1</span>f&#125;</span>ms&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obs_dict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_action</span>(<span class="params">self, action: <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_connected:</span><br><span class="line">            <span class="keyword">raise</span> DeviceNotConnectedError(<span class="string">f&quot;<span class="subst">&#123;self&#125;</span> is not connected.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        goal_pos = &#123;key.removesuffix(<span class="string">&quot;.pos&quot;</span>): val <span class="keyword">for</span> key, val <span class="keyword">in</span> action.items() <span class="keyword">if</span> key.endswith(<span class="string">&quot;.pos&quot;</span>)&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Cap goal position when too far away from present position.</span></span><br><span class="line">        <span class="comment"># /!\ Slower fps expected due to reading from the follower.</span></span><br><span class="line">        <span class="keyword">if</span> self.config.max_relative_target <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            present_pos = self.bus.sync_read(<span class="string">&quot;Present_Position&quot;</span>)</span><br><span class="line">            goal_present_pos = &#123;key: (g_pos, present_pos[key]) <span class="keyword">for</span> key, g_pos <span class="keyword">in</span> goal_pos.items()&#125;</span><br><span class="line">            goal_pos = ensure_safe_goal_position(goal_present_pos, self.config.max_relative_target)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Send goal position to the arm</span></span><br><span class="line">        self.bus.sync_write(<span class="string">&quot;Goal_Position&quot;</span>, goal_pos)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">f&quot;<span class="subst">&#123;motor&#125;</span>.pos&quot;</span>: val <span class="keyword">for</span> motor, val <span class="keyword">in</span> goal_pos.items()&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中send_action会sync_write
给电机，其它程序都是读，不会写，所以不会阻塞。</p>
<h1 id="debug配置文件自存">debug配置文件自存</h1>
<h2 id="服务器">服务器</h2>
<p>需要训练、async推理 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lerobot_train训练&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/user/miniconda3/envs/lerobot/bin/lerobot-train&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;--policy.path=lerobot/smolvla_base&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--dataset.repo_id=test1110/merged&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--batch_size=64&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--steps=20000&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--output_dir=outputs/train/joint_action_joint_state&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--job_name=my_smolvla_training_joint&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--policy.device=cuda&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--wandb.enable=false&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--policy.push_to_hub=false&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--rename_map=&#123;\&quot;observation.images.side\&quot;:\&quot;observation.images.camera1\&quot;,\&quot;observation.images.wrist\&quot;:\&quot;observation.images.camera2\&quot;&#125;&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="comment">// ,\&quot;joint_action\&quot;:\&quot;action\&quot;,\&quot;action\&quot;:\&quot;ee_action\&quot;,\&quot;action_is_pad\&quot;:\&quot;ee_action_is_pad\&quot;,\&quot;joint_action_is_pad\&quot;:\&quot;action_is_pad\&quot;</span></span><br><span class="line">            <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;HF_HUB_OFFLINE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integratedTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;justMyCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;python&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/user/miniconda3/envs/lerobot/bin/python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/user/working_folder/lerobot&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;server async推理&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lerobot.async_inference.policy_server&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;--host=10.10.16.18&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--port=8080&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--fps=30&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--inference_latency=0.033&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--obs_queue_timeout=1&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;HF_HUB_OFFLINE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integratedTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;justMyCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;python&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/user/miniconda3/envs/lerobot/bin/python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/user/working_folder/lerobot&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="pipeline">pipeline</h1>
<p>折磨了我很久的代码。 用joint-&gt;ee举例 ### <strong>1.
DataProcessorPipeline</strong></p>
<ul>
<li><p>类似一个“流水线”，把输入数据依次经过多个处理步骤（<code>ProcessorStep</code>）处理。</p></li>
<li><p>核心函数：</p>
<ul>
<li><p><code>__call__(data)</code>：</p>
<ol type="1">
<li><p><code>transition = self.to_transition(data)</code> →
将原始输入（<code>RobotObservation</code>）转成标准化的
<code>EnvTransition</code> 字典。</p></li>
<li><p><code>transformed_transition = self._forward(transition)</code> →
遍历每个 <code>ProcessorStep</code> 对 transition 处理。</p></li>
<li><p><code>return self.to_output(transformed_transition)</code> →
将最终 <code>EnvTransition</code> 转回需要的输出格式（在你这就是
<code>RobotObservation</code>）。</p></li>
</ol></li>
<li><p><code>_forward(transition)</code>：</p>
<ul>
<li><p>遍历 pipeline 的每个 <code>ProcessorStep</code>。</p></li>
<li><p>执行前/后 hook（这里没有自定义 hook，所以可以忽略）。</p></li>
<li><p>每步处理都返回新的 <code>EnvTransition</code>，并覆盖之前的
transition。</p></li>
</ul></li>
</ul></li>
</ul>
<hr />
<h3 id="observation_to_transition"><strong>2.
observation_to_transition</strong></h3>
<ul>
<li>将原始观测（<code>RobotObservation</code>，也就是你的
<code>raw_observation_state</code>）转换成
<code>EnvTransition</code>：</li>
</ul>
<p><code>&#123;   TransitionKey.OBSERVATION: observation,   TransitionKey.ACTION: None,   TransitionKey.REWARD: 0.0,   TransitionKey.DONE: False,   TransitionKey.TRUNCATED: False,   TransitionKey.INFO: &#123;&#125;,   TransitionKey.COMPLEMENTARY_DATA: &#123;&#125;, &#125;</code></p>
<ul>
<li>也就是说，它只是包装了一下原始观测，添加了 action、reward、done
等默认字段。</li>
</ul>
<hr />
<h3 id="forwardkinematicsjointstoee"><strong>3.
ForwardKinematicsJointsToEE</strong></h3>
<ul>
<li><p>一个 <code>ProcessorStep</code>，负责把 joint 信息转成
end-effector (EE) 信息。</p></li>
<li><p><code>__post_init__()</code>：</p>
<ul>
<li><p>初始化两个子处理器：</p>
<ul>
<li><p><code>ForwardKinematicsJointsToEEAction</code>（处理动作中的
joint→EE，通常不需要）</p></li>
<li><p><code>ForwardKinematicsJointsToEEObservation</code>（处理观测中的
joint→EE）</p></li>
</ul></li>
</ul></li>
<li><p><code>__call__(transition)</code>：</p>
<ul>
<li><p>如果 transition 中有 <code>action</code>，处理
action（这里没有，所以跳过）。</p></li>
<li><p>如果 transition 中有 <code>observation</code>，调用
<code>ForwardKinematicsJointsToEEObservation</code> 处理。</p></li>
</ul></li>
<li><p><strong>作用</strong>：对 <code>EnvTransition</code> 的
observation 做 FK 计算，并添加 EE 数据。</p></li>
</ul>
<hr />
<h3 id="observationprocessorstep"><strong>4.
ObservationProcessorStep</strong></h3>
<ul>
<li><p>抽象类，用于专门处理 transition 中的
<code>OBSERVATION</code>。</p></li>
<li><p>子类只需要实现 <code>observation()</code> 方法即可。</p></li>
<li><p><code>__call__(transition)</code>：</p>
<ol type="1">
<li><p>复制 transition。</p></li>
<li><p>调用 <code>self.observation(observation)</code>。</p></li>
<li><p>将处理后的 observation 放回 transition。</p></li>
</ol></li>
</ul>
<hr />
<h3 id="forwardkinematicsjointstoeeobservation"><strong>5.
ForwardKinematicsJointsToEEObservation</strong></h3>
<ul>
<li><p><code>ObservationProcessorStep</code> 的具体实现。</p></li>
<li><p><code>observation(observation)</code>：</p>
<ul>
<li>调用 <code>compute_forward_kinematics_joints_to_ee()</code>，把
joint 信息计算成 EE pose。</li>
</ul></li>
<li><p><strong>核心逻辑</strong>：</p></li>
</ul>
<p><code>motor_joint_values = [joints[f"&#123;n&#125;.pos"] for n in motor_names] q = np.array(motor_joint_values) t = kinematics.forward_kinematics(q) pos = t[:3, 3] tw = Rotation.from_matrix(t[:3, :3]).as_rotvec() # 删除原 joint 信息，添加 EE 数据 joints["ee.x"] = pos[0] joints["ee.y"] = pos[1] joints["ee.z"] = pos[2] joints["ee.wx"] = tw[0] joints["ee.wy"] = tw[1] joints["ee.wz"] = tw[2] joints["ee.gripper_pos"] = joints["gripper.pos"]</code></p>
<ul>
<li>返回修改后的 observation。</li>
</ul>
<hr />
<h3 id="compute_forward_kinematics_joints_to_ee"><strong>6.
compute_forward_kinematics_joints_to_ee</strong></h3>
<ul>
<li><p>真正的 FK 计算逻辑。</p></li>
<li><p>输入：joint dict, kinematics 对象, motor names</p></li>
<li><p>输出：包含 EE pose 的 observation dict。</p></li>
</ul>
<hr />
<h3 id="transition_to_observation"><strong>7.
transition_to_observation</strong></h3>
<ul>
<li><p>只取 <code>EnvTransition</code> 中的 <code>OBSERVATION</code>
部分返回。</p></li>
<li><p>所以最终
<code>obs_processed = self.robot_joints_to_ee_pose_processor(raw_observation_state)</code>
得到的就是原 observation 加上 EE 信息。</p></li>
</ul>
<hr />
<h3 id="总结数据处理流程"><strong>总结数据处理流程</strong></h3>
<ol type="1">
<li><p><strong>输入</strong>：<code>raw_observation_state</code>（dict，包含
joint 信息）。</p></li>
<li><p><code>observation_to_transition</code> → 包装成
<code>EnvTransition</code>。</p></li>
<li><p><code>_forward()</code>：</p>
<ul>
<li><p>调用 <code>ForwardKinematicsJointsToEE.__call__()</code>：</p>
<ul>
<li><p>调用
<code>ForwardKinematicsJointsToEEObservation.__call__()</code>：</p>
<ul>
<li>调用 <code>observation()</code> →
<code>compute_forward_kinematics_joints_to_ee()</code> → 计算 EE，修改
observation。</li>
</ul></li>
</ul></li>
</ul></li>
<li><p><code>transition_to_observation</code> → 返回最终
<code>RobotObservation</code>（包含 EE 数据）。</p></li>
</ol>
<p><strong>最终处理结果</strong>：</p>
<ul>
<li><p>原来的 joint 数据被移除（如果 motor_name 对应的 joint
被删除的话）。</p></li>
<li><p>添加了 EE 的位置和旋转信息：</p>
<p><code>'ee.x', 'ee.y', 'ee.z', 'ee.wx', 'ee.wy', 'ee.wz', 'ee.gripper_pos'</code></p></li>
</ul>
<h1 id="可能的报错">可能的报错</h1>
<ol type="1">
<li>有opencv和realsense相机的时候，如果遇到realsense相机报错<code>RuntimeError: xioctl(VIDIOC_S_FMT) failed, errno=16 Last Error: Device or resource busy</code>
那多半是因为设置opencv的时候写错了id，它先打开了realsense需要的一个接口。那realsense要打开的时候就报错说占用了，可以在执行（debug）的时候检查<code>lsof /dev/video*</code>查看目前占用的端口号，<code>v4l2-ctl --list-devices</code>检查设备与端口号对应情况</li>
</ol>
<h1 id="坐标转换">坐标转换</h1>
<p>直接从本地数据集获取后计算平均值</p>
<p>打印出来贴上去 from pupil_apriltags import Detector 安装这个</p>
<p>训练ACT HF_HUB_OFFLINE=1 CUDA_VISIBLE_DEVICES=0 accelerate
launch<br />
--multi_gpu<br />
--num_processes=3<br />
src/lerobot/scripts/lerobot_train.py<br />
--config_path=fscript/finetune/simple_test.yaml</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/robot/" rel="tag"># robot</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/10/22/%E8%91%B5%E8%8A%B1%E5%AE%9D%E5%85%B8%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AB%E8%91%B5%E8%8A%B1%E5%AE%9D%E5%85%B8/" rel="prev" title="研究修炼指南">
                  <i class="fa fa-angle-left"></i> 研究修炼指南
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/10/27/%E6%8E%A7%E5%88%B6/" rel="next" title="控制">
                  控制 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">milong26</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
